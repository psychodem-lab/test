<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Psychologa - System Diagnostyczny</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --border: #e2e8f0;
            --accent: #4f46e5;
            --danger: #dc2626;
            --warning-bg: #fef2f2;
        }
        /* Klasa aktywowana przez JavaScript */
        body.dark-mode {
            --bg: #0f172a;
            --surface: #1e293b;
            --text: #babaaf;
            --muted: #94a3b8;
            --border: #334155;
            --accent: #818cf8;
        }
        
        /* Dodatkowe dopasowanie dla czytelno≈õci w trybie nocnym */
        body.dark-mode .opt-label:hover { background: #334155; }
        body.dark-mode .opt-label.selected { background: #312e81; border-color: var(--primary); }
        body.dark-mode .result-panel { background: #1e293b; border-color: #334155; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { 
            background: #0f172a; color: white; border-color: var(--border); 
        }

        /* --- Global Reset & Mobile --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.5;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Login Screen --- */
        #login-screen {
            position: fixed;
            inset: 0; background: var(--bg);
            display: flex; align-items: center; justify-content: center; z-index: 2000;
            padding: 20px;
        }
        .login-card {
            background: var(--surface);
            padding: 2rem; border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px;
            text-align: center;
        }
        .login-card h2 { margin-bottom: 1.5rem; }
        .login-card input {
            width: 100%;
            padding: 0.8rem; margin-bottom: 1rem;
            border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;
        }

        /* --- Dashboard Layout --- */
        #dashboard { display: none; padding: 1rem; max-width: 900px; margin: 0 auto; padding-bottom: 80px; }
        
        header {
            background: var(--surface);
            padding: 1.5rem; border-radius: 12px;
            margin-bottom: 1rem; border: 1px solid var(--border);
        }
        .patient-data {
            display: grid;
            grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 1rem;
        }
        input[type="text"], input[type="date"], select {
            width: 100%;
            padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px;
            font-family: inherit; font-size: 0.9rem;
        }

        /* --- Tabs --- */
        .nav-tabs {
            display: flex;
            gap: 8px; overflow-x: auto; padding-bottom: 8px;
            margin-bottom: 1.5rem; scrollbar-width: none;
        }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .tab-link {
            flex: 0 0 auto;
            background: var(--surface); border: 1px solid var(--border);
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem;
            font-weight: 500; transition: 0.2s;
        }
        .tab-link.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- Test Content --- */
        .test-section { display: none;
            background: var(--surface); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border);
        }
        .test-section.active { display: block; }
        .test-header { margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
        .test-header h2 { font-size: 1.25rem; }
        .test-header p { font-size: 0.85rem; color: var(--muted); margin-top: 4px; }

        /* --- Question UI --- */
        .question-row { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px outline var(--bg); }
        .q-text { font-weight: 500; display: block; margin-bottom: 0.75rem; font-size: 0.95rem; }
        .options-group { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .opt-label {
            flex: 1;
            min-width: 60px; display: flex; flex-direction: column; align-items: center;
            padding: 10px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;
            font-size: 0.8rem;
            transition: 0.2s; text-align: center;
        }
        .opt-label:hover { background: #f1f5f9; }
        .opt-label input { margin-bottom: 4px; }
        .opt-label.selected { background: #e0e7ff; border-color: var(--primary); }

        /* --- Result Styling --- */
        .result-panel {
            margin-top: 2rem;
            padding: 1.5rem; background: #f1f5f9; border-radius: 8px;
            border-left: 4px solid var(--primary); display: none;
        }
        .res-line { display: flex; justify-content: space-between; margin-bottom: 0.4rem; padding: 5px 0; border-bottom: 1px solid #e2e8f0; }
        .res-line span { font-weight: bold; }

        /* --- Critical Alert Box (Feature 3) --- */
        .alert-box {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--warning-bg);
            border: 2px solid var(--danger);
            border-radius: 8px;
            color: var(--danger);
            font-weight: bold;
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        /* --- Notes Section (Feature 7) --- */
        .clinician-notes-area {
            margin-top: 2rem;
            border-top: 2px dashed var(--border);
            padding-top: 1.5rem;
        }
        .clinician-notes-area label {
            font-weight: 600; font-size: 0.9rem; color: var(--muted); display: block; margin-bottom: 0.5rem;
        }
        .clinician-notes-area textarea {
            width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px;
            font-family: inherit; font-size: 0.9rem; resize: vertical; min-height: 80px;
            background: #fffff0; /* Light yellow to distinguish notes */
        }

        /* --- Action Buttons --- */
        .actions {
            position: fixed;
            bottom: 0; left: 0; right: 0; 
            display: flex; gap: 10px; justify-content: center; padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid var(--border);
            backdrop-filter: blur(5px);
            z-index: 1000;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 30px; border: none; font-weight: 600;
            cursor: pointer; font-size: 0.85rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-calc { background: var(--accent); color: white; }
        .btn-print { background: #10b981; color: white; }
        .btn-pdf { background: #ea580c; color: white; } /* Orange for PDF */
        .btn-csv { background: #0891b2; color: white; } /* Cyan for CSV */
        .btn-clear { background: #64748b; color: white; font-size: 0.75rem; padding: 8px 16px;}

        /* --- CONTRACT STYLES --- */
        textarea.contract-input {
            width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px;
            font-family: inherit; font-size: 0.95rem; resize: vertical; margin-top: 5px; margin-bottom: 10px;
        }
        .contract-agreement {
            background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--primary);
        }
        .sig-line {
            margin-top: 10px; border-top: 1px dashed var(--muted); padding-top: 5px;
        }
        .sig-container {
            margin-top: 10px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .sig-canvas {
            display: block;
            width: 100%; /* Dopasuje siƒô do szeroko≈õci ekranu */
            height: 150px;
            cursor: crosshair;
            touch-action: none; /* Kluczowe dla urzƒÖdze≈Ñ mobilnych - blokuje przewijanie podczas podpisu */
        }
        .sig-actions {
            background: #f8fafc;
            padding: 5px 10px;
            text-align: right;
            border-top: 1px solid var(--border);
        }
        .btn-clear-sig {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 0.7rem;
            cursor: pointer;
            font-weight: 600;
        }

        /* --- PRINT STYLES --- */
        @media print {
            body { background: white; padding-bottom: 0; }
            #login-screen, .nav-tabs, .actions, .btn-calc, header h1, .btn-clear { display: none !important; }
            #dashboard { display: block !important; padding: 0; width: 100%; padding-bottom: 0; }
            .test-section { display: none !important; }
            .test-section.active { display: block !important; border: none !important; }
            .result-panel { display: block !important; background: white !important; border: 1px solid #000 !important; }
            input, textarea { border: none !important; font-weight: bold; font-family: 'Times New Roman', serif; }
            textarea { resize: none; overflow: visible; height: auto; }
            .contract-agreement { border: 1px solid #ccc; background: white; }
            .clinician-notes-area { border-top: 1px solid black; }
            .clinician-notes-area textarea { background: white; border: none; }
        }

        @media (max-width: 600px) {
            .options-group { display: grid; grid-template-columns: 1fr; }
            .opt-label { flex-direction: row; gap: 10px; text-align: left; }
            .actions { padding: 10px; gap: 5px; }
            .btn { flex: 1; text-align: center; padding: 10px 5px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h2>Panel Psychologa</h2>
        <input type="password" id="pass" placeholder="Has≈Ço">
        <button class="btn btn-calc" style="width:100%" onclick="login()">Zaloguj siƒô</button>
    </div>
</div>

<div id="dashboard">
    <header>
        <h1>System Diagnostyczny</h1>
        <button onclick="toggleDarkMode()" class="btn" style="position: absolute; top: 15px; right: 15px; font-size: 0.7rem; padding: 5px 10px;">
    Tryb Nocny üåô </button>
        <div class="patient-data">
            <div>
                <label style="font-size:0.7rem; color:var(--muted)">Inicja≈Çy Pacjenta</label>
                <input type="text" id="p-init" placeholder="np. A.B.">
            </div>
            
            <div>
                <label style="font-size:0.7rem; color:var(--muted)">P≈Çeƒá</label>
                <select id="p-gender">
                    <option value="K">Kobieta</option>
                    <option value="M">Mƒô≈ºczyzna</option>
                </select>
            </div>
            <div>
                <label style="font-size:0.7rem; color:var(--muted)">Grupa wiekowa</label>
                <select id="p-age-group">
                    <option value="0-16">0 - 16 lat</option>
                    <option value="16-24">16 - 24 lata</option>
                    <option value="25-54">25 - 54 lata</option>
                    <option value="55-79">55 - 79 lat</option>
                </select>
            </div>
            <div>
                <label style="font-size:0.7rem; color:var(--muted)">Data badania</label>
                <input type="date" id="p-date">
            </div>
        </div>
    </header>

    <nav class="nav-tabs">
        <button class="tab-link active" onclick="openTab(event, 't-dass')">DASS-21</button>
        <button class="tab-link" onclick="openTab(event, 't-dass42')">DASS-42</button>
        <button class="tab-link" onclick="openTab(event, 't-dassy')">DASSY (Dzieci)</button>
        <button class="tab-link" onclick="openTab(event, 't-bdi')">BDI-II</button>
        <button class="tab-link" onclick="openTab(event, 't-lsas')">LSAS</button>
        <button class="tab-link" onclick="openTab(event, 't-ciss')">CISS</button>
        <button class="tab-link" onclick="openTab(event, 't-contract')">Kontrakt na ≈ºycie</button>
    </nav>

    <div id="t-dass" class="test-section active">
        <div class="test-header">
            <h2>DASS-21</h2>
            <p>Skala Depresji, Lƒôku i Stresu (0 - wcale, 3 - bardzo czƒôsto).</p>
        </div>
        <form id="f-dass"></form>
        <div id="res-dass" class="result-panel"></div>
        <div class="clinician-notes-area">
            <label>Notatki kliniczne / Obserwacje:</label>
            <textarea id="note-dass" placeholder="Wpisz obserwacje dot. pacjenta..."></textarea>
        </div>
    </div>

    <div id="t-dass42" class="test-section">
        <div class="test-header"><h2>DASS-42</h2><p>Pe≈Çna Skala Depresji, Lƒôku i Stresu.(0 - wcale, 3 - bardzo czƒôsto)</p></div>
        <form id="f-dass42"></form><div id="res-dass42" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-dass42"></textarea></div>
    </div>

    <div id="t-dassy" class="test-section">
        <div class="test-header"><h2>DASSY</h2><p>Skala dla dzieci i m≈Çodzie≈ºy. (0 - wcale, 3 - bardzo czƒôsto) </p></div>
        <form id="f-dassy"></form><div id="res-dassy" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-dassy"></textarea></div>
    </div>

    <div id="t-phq9" class="test-section">
        <div class="test-header"><h2>PHQ-9</h2><p>Kwestionariusz Zdrowia Pacjenta.</p></div>
        <form id="f-phq9"></form><div id="res-phq9" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-phq9"></textarea></div>
    </div>

    <div id="t-gad7" class="test-section">
        <div class="test-header"><h2>GAD-7</h2><p>Skala Lƒôku Uog√≥lnionego.</p></div>
        <form id="f-gad7"></form><div id="res-gad7" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-gad7"></textarea></div>
    </div>

    <div id="t-bdi" class="test-section">
        <div class="test-header"><h2>BDI-II</h2><p>Inwentarz Depresji Becka.</p></div>
        <form id="f-bdi"></form><div id="res-bdi" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-bdi"></textarea></div>
    </div>

    <div id="t-lsas" class="test-section">
        <div class="test-header"><h2>LSAS (Leibowitz)</h2><p>Ocena lƒôku spo≈Çecznego.</p></div>
        <form id="f-lsas"></form><div id="res-lsas" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-lsas"></textarea></div>
    </div>

    <div id="t-ciss" class="test-section">
        <div class="test-header">
            <h2>CISS</h2>
            <p>Radzenie Sobie w Sytuacjach Stresowych (1 - nigdy, 5 - bardzo czƒôsto).</p>
        </div>
        <form id="f-ciss"></form>
        <div id="res-ciss" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-ciss"></textarea></div>
    </div>

    <div id="t-contract" class="test-section">
        <div class="test-header">
            <h2>Kontrakt na ≈ºycie</h2>
            <p>Plan bezpiecze≈Ñstwa i umowa terapeutyczna.</p>
        </div>

        <div class="question-row">
            <label><strong>Miejscowo≈õƒá i data:</strong></label>
            <input type="text" id="cnt-loc" placeholder="Wpisz miejscowo≈õƒá i datƒô">
        </div>

        <div style="margin-bottom: 2rem; line-height: 1.6; font-size: 0.95rem;">
            <p>Kiedy czujemy siƒô przygnƒôbieni, mo≈ºemy my≈õleƒá o zadawaniu sobie b√≥lu lub nawet zabiciu siebie. Faktycznie, my≈õli samob√≥jcze sƒÖ jednym z mo≈ºliwych objaw√≥w depresji. Takie my≈õli czy impulsy mogƒÖ siƒô zdarzyƒá, ale bardzo wa≈ºne jest to, ≈ºeby≈õmy mogli o nich rozmawiaƒá. Najwa≈ºniejsze jest twoje bezpiecze≈Ñstwo. Dlatego bƒôdziemy rozmawiaƒá o r√≥≈ºnych trudnych sprawach, nawet o chƒôci odebrania sobie ≈ºycia. Za chwilƒô um√≥wimy siƒô, ≈ºe bƒôdziemy robiƒá wszystko, ≈ºeby poradziƒá sobie w trudnej sytuacji. W umowie przyjrzymy siƒô, kiedy mia≈Çe≈õ/a≈õ my≈õli samob√≥jcze w przesz≈Ço≈õci, jakiego rodzaju my≈õli pomog≈Çy Ci je przezwyciƒô≈ºyƒá i stworzymy plan reagowania w sytuacjach, kiedy takie my≈õli i impulsy pojawia siƒô podczas trwania naszej wsp√≥lnej pracy.</p>
        </div>

        <div class="question-row">
            <label class="q-text">Proszƒô opisz sytuacjƒô, je≈ºeli taka istnieje, w kt√≥rej poczu≈Ça≈õ impuls do pope≈Çnienia samob√≥jstwa w ostatnim okresie. Je≈õli by≈Ço ich kilka, pomy≈õl o najgorszej z nich.</label>
            <textarea id="cnt-q1" class="contract-input" rows="3"></textarea>
        </div>

        <h3>Co umo≈ºliwi≈Ço Ci poczuƒá siƒô lepiej w ostatnim czasie?</h3>
        
        <div class="question-row">
            <label class="q-text">Jakie my≈õli pozwoli≈Çy Ci poczuƒá siƒô lepiej?</label>
            <textarea id="cnt-q2" class="contract-input" rows="2"></textarea>
        </div>
        <div class="question-row">
            <label class="q-text">Jacy ludzie pomogli Ci poczuƒá siƒô lepiej?</label>
            <textarea id="cnt-q3" class="contract-input" rows="2"></textarea>
        </div>
        <div class="question-row">
            <label class="q-text">Czy co≈õ z rzeczy, kt√≥re robi≈Çe≈õ/a≈õ pomog≈Ço Ci poczuƒá siƒô lepiej?</label>
            <textarea id="cnt-q4" class="contract-input" rows="2"></textarea>
        </div>

        <h3>Co prawdopodobnie mog≈Çoby Ci pom√≥c, gdyby≈õ zaczƒÖ≈Ç/ƒô≈Ça mieƒá my≈õli samob√≥jcze?</h3>

        <div class="question-row">
            <label class="q-text">Jakie my≈õli mog≈Çyby Ci pom√≥c, aby przezwyciƒô≈ºyƒá samob√≥jcze my≈õli lub impulsy?</label>
            <textarea id="cnt-q5" class="contract-input" rows="2"></textarea>
        </div>
        <div class="question-row">
            <label class="q-text">Jakich ludzi m√≥g≈Çby≈õ /mog≈Çaby≈õ w to w≈ÇƒÖczyƒá?</label>
            <textarea id="cnt-q6" class="contract-input" rows="2"></textarea>
        </div>
        <div class="question-row">
            <label class="q-text">Jaki mo≈ºe byƒá plan dzia≈Çania, je≈õli bƒôdziesz mieƒá my≈õli lub impulsy samob√≥jcze?</label>
            <textarea id="cnt-q7" class="contract-input" rows="3"></textarea>
        </div>

        <hr style="margin: 2rem 0; border: 0; border-top: 1px solid var(--border);">

        <div class="contract-agreement">
            <p>Obiecujƒô ≈ºe nie pope≈Çniƒô samob√≥jstwa i bƒôdƒô rozmawia≈Ç/a o my≈õlach i tendencjach samob√≥jczych z lekarzem/psychologiem/terapeutƒÖ/pracownikiem socjalnym.</p>
                        <div class="sig-container">
                <canvas id="canvas-sig1" class="sig-canvas" width="400" height="150"></canvas>
                <div class="sig-actions">
                    <button type="button" class="btn-clear-sig" onclick="clearCanvas('canvas-sig1')">Wyczy≈õƒá podpis</button>
                </div>
            </div>
            
        </div>

        <div class="contract-agreement">
            <p>Obiecujƒô ≈ºe powiem innym doros≈Çym, ≈ºe bardzo ≈∫le siƒô czujƒô i poproszƒô, ≈ºeby zawiadomili mojego lekarza/terapeutƒô.</p>
         <div class="sig-container">
                <canvas id="canvas-sig1" class="sig-canvas" width="400" height="150"></canvas>
                <div class="sig-actions">
                    <button type="button" class="btn-clear-sig" onclick="clearCanvas('canvas-sig1')">Wyczy≈õƒá podpis</button>
                </div>
            </div>
        </div>

        <div class="contract-agreement">
            <p>Obiecujƒô, ≈ºe je≈ºeli nikogo nie bƒôdzie w pobli≈ºu, to w przypadku ostrych my≈õli samob√≥jczych sam/a zg≈Çoszƒô siƒô na ostry dy≈ºur do szpitala.</p>
          <div class="sig-container">
                <canvas id="canvas-sig1" class="sig-canvas" width="400" height="150"></canvas>
                <div class="sig-actions">
                    <button type="button" class="btn-clear-sig" onclick="clearCanvas('canvas-sig1')">Wyczy≈õƒá podpis</button>
                </div>
            </div>
        </div>

        <div class="contract-agreement">
            <p>Obiecujƒô ≈ºe nie posiadam dostƒôpu do broni ani innych zab√≥jczych ≈õrodk√≥w.</p>
          <div class="sig-container">
                <canvas id="canvas-sig1" class="sig-canvas" width="400" height="150"></canvas>
                <div class="sig-actions">
                    <button type="button" class="btn-clear-sig" onclick="clearCanvas('canvas-sig1')">Wyczy≈õƒá podpis</button>
                </div>
            </div>
        </div>

        <div class="question-row" style="margin-top: 2rem;">
            <label><strong>Podpis osoby pomagajƒÖcej:</strong></label>
            <input type="text" id="cnt-therapist" style="margin-top: 5px;">
        </div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-contract"></textarea></div>
    </div>

    <div class="actions">
        <button class="btn btn-calc" onclick="calculateCurrent()">Oblicz wynik</button>
        <button class="btn btn-print" onclick="window.print()">Drukuj (Pe≈Çny)</button>
        <button class="btn btn-pdf" onclick="exportPDF()">Eksport PDF</button>
        <button class="btn btn-csv" onclick="exportCSV()">Eksport CSV (Excel)</button>
        <button class="btn btn-clear" onclick="clearData()">Wyczy≈õƒá dane</button>
    </div>
</div>

<script>
    const PASS = "psy26";
    // Feature 4: LocalStorage Key
    const STORAGE_KEY = 'psy_panel_data_v1';

    function login() {
        if(document.getElementById('pass').value === PASS) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('p-date').valueAsDate = new Date();
            initTests();
            loadProgress(); // Feature 4: Load Data
            initAutoSave(); // Feature 4: Init Saver
            initSignaturePads(); // DODAJ Tƒò LINIE
            loadSignatures();    // DODAJ Tƒò LINIE
        } else alert("B≈Çƒôdne has≈Ço");
    }

    function openTab(evt, id) {
        document.querySelectorAll('.test-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        evt.currentTarget.classList.add('active');
        window.scrollTo(0,0);
    }

    function initTests() {
        // DASS-21
        const dQ = ["Trudno by≈Ço mi siƒô uspokoiƒá", "Czu≈Çem(am) sucho≈õƒá w ustach", "Nie potrafi≈Çem(am) odczuwaƒá ≈ºadnych pozytywnych uczuƒá", "Mia≈Çem(am) trudno≈õci z oddychaniem (np. szybki oddech)", "Trudno by≈Ço mi nabraƒá inicjatywy do dzia≈Çania", "Mia≈Çem(am) tendencjƒô do przesadnego reagowania", "Czu≈Çem(am) dr≈ºenie (np. rƒÖk)", "Czu≈Çem(am), ≈ºe zu≈ºywam du≈ºo nerwowej energii", "Martwi≈Çem(am) siƒô sytuacjami, w kt√≥rych mogƒô wpa≈õƒá w panikƒô", "Czu≈Çem(am), ≈ºe nie mam na co czekaƒá w przysz≈Ço≈õci", "Czu≈Çem(am), ≈ºe stajƒô siƒô poddenerwowany(a)", "Trudno by≈Ço mi siƒô zrelaksowaƒá", "Czu≈Çem(am) siƒô przygnƒôbiony(a) i smutny(a)", "Nie tolerowa≈Çem(am) niczego, co przeszkadza≈Ço mi w dzia≈Çaniu", "Czu≈Çem(am), ≈ºe jestem bliski(a) paniki","Nie potrafi≈Çem(am) siƒô niczym entuzjazmowaƒá", "Czu≈Çem(am), ≈ºe nie jestem wiele wart(a)", "Czu≈Çem(am), ≈ºe jestem przewra≈ºliwiony(a)", "By≈Çem(am) ≈õwiadomy(a) rytmu serca bez wysi≈Çku", "Czu≈Çem(am) siƒô wystraszony(a) bez powodu", "Czu≈Çem(am), ≈ºe ≈ºycie nie ma sensu"];
        genForm('f-dass', dQ, 4, 'd');

        // DASS-42
        const d42Q = [
            "Trudno by≈Ço mi siƒô uspokoiƒá", "Czu≈Çem sucho≈õƒá w ustach", "Nie potrafi≈Çem odczuwaƒá pozytywnych uczuƒá", "Trudno≈õci z oddychaniem", "Trudno mi by≈Ço zaczƒÖƒá jakƒÖ≈õ czynno≈õƒá", "Przesadnie reagowa≈Çem na sytuacje", "Czu≈Çem dr≈ºenie (np. rƒÖk)", "Czu≈Çem, ≈ºe zu≈ºywam du≈ºo energii", "Ba≈Çem siƒô sytuacji paniki", "Nie mia≈Çem na co czekaƒá", "Stawa≈Çem siƒô poddenerwowany", "Trudno mi by≈Ço siƒô zrelaksowaƒá", "Czu≈Çem siƒô przygnƒôbiony", "Nie tolerowa≈Çem przeszk√≥d", "Czu≈Çem, ≈ºe jestem bliski paniki", "Brak entuzjazmu", "Czu≈Çem, ≈ºe nie jestem wiele wart", "By≈Çem przewra≈ºliwiony", "≈öwiadomo≈õƒá rytmu serca", "Ba≈Çem siƒô bez powodu", "Czu≈Çem, ≈ºe ≈ºycie nie ma sensu", "Trudno mi by≈Ço siƒô odprƒô≈ºyƒá", "Problemy z po≈Çykaniem", "Brak rado≈õci z czegokolwiek", "≈öwiadomo≈õƒá bicia serca", "Czu≈Çem smutek i przygnƒôbienie", "By≈Çem bardzo dra≈ºliwy", "By≈Çem bliski paniki", "Trudno mi by≈Ço siƒô wyciszyƒá", "Ba≈Çem siƒô, ≈ºe co≈õ mnie przerazi", "Brak entuzjazmu dla plan√≥w", "Trudno mi by≈Ço zaczƒÖƒá dzia≈Çanie", "Czu≈Çem, ≈ºe jestem do niczego", "By≈Çem nietolerancyjny", "Czu≈Çem brak tchu", "Czu≈Çem brak nadziei", "≈ªycie wydawa≈Ço mi siƒô bezwarto≈õciowe", "≈Åatwo wpada≈Çem w irytacjƒô", "Poci≈Çem siƒô (bez upa≈Çu/wysi≈Çku)", "Ba≈Çem siƒô bez konkretnego powodu", "Czu≈Çem, ≈ºe ≈ºycie jest bez sensu", "Trudno by≈Ço mi siƒô uspokoiƒá po zdenerwowaniu"
        ];
        genForm('f-dass42', d42Q, 4, 'd42');

        // DASSY
        const dyQ = [
            "Denerwowa≈Çem/am siƒô z powodu drobnych rzeczy", "Czu≈Çem/am zawroty g≈Çowy, jakbym mia≈Ç/a zemdleƒá", "Nic mnie nie cieszy≈Ço", "Mia≈Çem/am trudno≈õci z oddychaniem (np. szybki oddech), mimo ≈ºe nie ƒáwiczy≈Çem/am i nie by≈Çem/am chory", "Nienawidzi≈Çem/am swojego ≈ºycia", "Reagowa≈Çem/am zbyt mocno na sytuacje", "Czu≈Çem dr≈ºenie rƒÖk", "Martwi≈Çem/am siƒô o wiele rzeczy", "By≈Çem/am przera≈ºony/a", "Nie by≈Ço nic, na co m√≥g≈Çbym/mog≈Çabym czekaƒá z rado≈õciƒÖ", "Szybko czu≈Çem irytacjƒô", "Trudno by≈Ço mi siƒô zrelaksowaƒá.", "Nie mog≈Çem/am przestaƒá czuƒá siƒô smutny/a", "Denerwowa≈Ço mnie, gdy ludzie mi przerywali.", "Mia≈Çem/am wra≈ºenie, ≈ºe zaraz spanikujƒô", "Nienawidzi≈Çem/am siebie", "Czu≈Çem/am, ≈ºe jestem do niczego.", "≈Åatwo siƒô irytowa≈Çem", "Czu≈Çem/am bardzo szybkie bicie serca, mimo ≈ºe nie wykonywa≈Çem/am intensywnego wysi≈Çku", "Czu≈Çem/am strach bez powodu", "Czu≈Çem/am, ≈ºe ≈ºycie jest okropne"
        ];
        genForm('f-dassy', dyQ, 4, 'dy');
        
        // PHQ-9
        const pQ = ["Ma≈Çe zainteresowanie/rado≈õƒá", "Przygnƒôbienie/beznadzieja", "Problemy ze snem", "Zmƒôczenie/brak energii", "Apetyt (brak/nadmiar)", "Poczucie pora≈ºki", "Problemy z koncentracjƒÖ", "Spowolnienie/pobudzenie", "My≈õli o samookaleczeniu"];
        genForm('f-phq9', pQ, 4, 'p', ["Wcale", "Kilka dni", "Po≈Çowa dni", "Codziennie"]);

        // GAD-7
        const gQ = ["Zdenerwowanie/lƒôk", "Brak kontroli nad martwieniem", "Martwienie siƒô na zapas", "Trudno siƒô odprƒô≈ºyƒá", "Niepok√≥j ruchowy", "Irytacja", "Strach przed najgorszym"];
        genForm('f-gad7', gQ, 4, 'g', ["Wcale", "Kilka dni", "Po≈Çowa dni", "Codziennie"]);

        // BDI-II
        const bQ = [
            {q: "Smutek", o: ["Nie jestem w og√≥le smutny ani przygnƒôbiony.", "Czujƒô siƒô smutny przez wiƒôkszo≈õƒá czasu.", "Jestem stale smutny i przygnƒôbiony.", "Jestem tak nieszczƒô≈õliwy i smutny, ≈ºe jest to nie do wytrzymania."]},
            {q: "Pesymizm", o: ["Nie obawiam siƒô o swojƒÖ przysz≈Ço≈õƒá.", "Obawiam siƒô o przysz≈Ço≈õƒá bardziej ni≈º dotychczas.", "Nie oczekujƒô, ≈ºe przysz≈Ço≈õƒá bƒôdzie siƒô dla mnie uk≈Çadaƒá pomy≈õlnie.", "Uwa≈ºam, ≈ºe moja przysz≈Ço≈õƒá jest beznadziejna i ≈ºe bƒôdzie coraz gorsza."]},
            {q: "Przesz≈Çe niepowodzenia", o: ["Nie czujƒô, ≈ºe odnosi≈Çem wiele pora≈ºek.", "Zawodzi≈Çem wiƒôcej razy ni≈º powinienem", "PatrzƒÖc wstecz, widzƒô du≈ºo niepowodze≈Ñ.", "Uwa≈ºam, ≈ºe jako cz≈Çowiek jestem totalnym nieudacznikiem."]},
            {q: "Odczuwanie przyjemno≈õci", o: ["Robienie rzeczy, kt√≥re lubiƒô dostarcza mi tyle samo przyjemno≈õci co w przesz≈Ço≈õci.", "To co robiƒô nie sprawia mi takiej samej przyjemno≈õci jak kiedy≈õ.", "Odczuwam bardzo niewiele przyjemno≈õci z rzeczy, kt√≥re kiedy≈õ lubi≈Çem.", "Nie odczuwam ≈ºadnej przyjemno≈õci z rzeczy, kt√≥re kiedy≈õ lubi≈Çem."]},
            {q: "Poczucie winy", o: ["Nie czuje siƒô szczeg√≥lnie winien.", "Czujƒô siƒô winny z powodu wielu rzeczy, kt√≥re zrobi≈Çem lub kt√≥rych nie zrobi≈Çem.", "Czujƒô siƒô winny przez wiƒôkszo≈õƒá czasu.", "Czuje siƒô winny bez przerwy."]},
            {q: "Poczucie kary", o: ["Nie czujƒô ≈ºebym by≈Ç karany.", "Czujƒô, ≈ºe mogƒô zostaƒá ukarany.", "Oczekujƒô kary.", "Czujƒô, ≈ºe jestem karany."]},
            {q: "Stosunek do samego siebie", o: ["Mam o sobie takie samo zdanie jak przedtem.", "Straci≈Çem wiarƒô w siebie.", "Zawiod≈Çem siƒô na sobie.", "Czujƒô do siebie niechƒôƒá."]},
            {q: "Samokrytycyzm", o: ["Nie krytykujƒô siebie anie nie obwiniam wiƒôcej ni≈º kiedy≈õ.", "Jestem bardziej krytycznie nastawiony do siebie ni≈º kiedy≈õ.", "Krytykujƒô siebie za wszystkie swoje niepowodzenia.", "Obwiniam siƒô za ka≈ºde z≈Ço, kt√≥re siƒô wydarza."]},
            {q: "My≈õli samob√≥jcze", o: ["Nie my≈õlƒô o zabiciu siƒô.", "My≈õlƒô o tym, by siƒô zabiƒá, ale wiem, ≈ºe bym tego nie zrobi≈Ç.", "Pragnƒô siƒô zabiƒá.", "Zabije siƒô je≈õli tylko natrafi siƒô odpowiednia do tego sposobno≈õƒá."]},
            {q: "P≈Çacz", o: ["Nie p≈Çaczƒô czƒô≈õciej ni≈º zazwyczaj.", "P≈Çaczƒô czƒô≈õciej ni≈º zazwyczaj.", "P≈Çaczƒô ciƒÖgle, nawet z powodu drobnostek.", "Chcia≈Çbym p≈Çakaƒá, ale nie jestem w stanie."]},
            {q: "Pobudzenie", o: ["Nie czuje siƒô bardziej niespokojny czy pobudzony ni≈º dawniej.", "Czuje siƒô bardziej niespokojny czy pobudzony ni≈º dawniej.", "Jestem tak pobudzony i niespokojny, ≈ºe trudno mi siƒô uspokoiƒá.", "Jestem tak pobudzony i nisepokojny, ≈ºe muszƒô wciƒÖ≈º co≈õ robiƒá lub poruszaƒá siƒô."]},
            {q: "Utrata zainteresowa≈Ñ", o: ["Ludzie i czynno≈õci codzienne interesujƒÖ mnie tak jak dawniej.", "Coraz mniej interesujƒÖ mnie otaczajƒÖcy mnie ludzie oraz czynno≈õci codzienne.", "Utraci≈Çem wiƒôkszo≈õƒá zainteresowania lud≈∫mi albo czynno≈õciami codziennymi.", "Trudno mi siƒô czymkolwiek zainteresowaƒá."]},
            {q: "Niezdecydowanie", o: ["Podejmujƒô decyzje tak ≈Çatwo jak kiedy≈õ.", "Trudniej jest mi podejmowaƒá decyzje ni≈º kiedy≈õ.", "Mam du≈ºƒÖ trudno≈õƒá w podejmowaniu decyzji.", "Nie jestem w stanie podejmowaƒá jakichkolwiek decyzji."]},
            {q: "Bezu≈ºyteczno≈õƒá", o: ["Nie czujƒô siƒô bezwarto≈õciowy.", "Nie uwa≈ºam, ≈ºe jestem r√≥wnie przydatny i warty uwagi jak kiedy≈õ.", "Czuje siƒô bardziej bezwarto≈õciowy w por√≥wnaniu do innych.", "Czujƒô siƒô ca≈Çkowicie bezwarto≈õciowy."]},
            {q: "Utrata energii", o: ["Mam tyle samo energii co dawniej.", "Mam mniej energii ni≈º dawniej.", "Nie mam wystarczajƒÖcej ilo≈õci energii aby wykonywaƒá wiƒôkszo≈õƒá czynno≈õci.", "Nie mam energii aby robiƒá cokolwiek."]},
            {q: "Zmiany we wzorcu snu", o: ["Sypiam tak dobrze jak dotychczas.", "≈öpiƒô nieco wiƒôcej/mniej ni≈º dotychczas.", "≈öpiƒô znacznie wiƒôcej/mniej ni≈º dotychczas.", "Budzƒô siƒô 1-2 godziny za wcze≈õnie i nie mogƒô ponownie usnƒÖƒá/ ≈õpiƒô przez wiƒôkszo≈õƒá dnia."]},
            {q: "Dra≈ºliwo≈õƒá", o: ["Nie jestem bardziej dra≈ºliwy ni≈º zazwyczaj.", "Jestem bardziej dra≈ºliwy ni≈º zazwyczaj.", "Jestem o wiele bardziej dra≈ºliwy ni≈º zazwyczaj.", "Jestem dra≈ºliwy przez ca≈Çy czas."]},
            {q: "Zmiany apetycie", o: ["Mam taki sam apetyt jak zwykle.", "Mam trochƒô mniejszy/wiƒôkszy apetyt ni≈º dotychczas.", "Mam znacznie mniejszy/wiƒôkszy apetyt ni≈º dotychczas.", "Nie mam w og√≥le apetytu / jestem g≈Çodny ca≈Çy czas."]},
            {q: "Problemy z koncentracjƒÖ", o: ["Umiem siƒô koncentrowaƒá tak dobrze jak wcze≈õniej.", "Nie umiem koncentrowaƒá siƒô tak dobrze jak wcze≈õniej.", "Trudno mi skupiƒá siƒô na czym≈õ przez d≈Çu≈ºszy czas.", "Nie mogƒô skoncentrowaƒá siƒô na niczym."]},
            {q: "Zmƒôczenie", o: ["Nie czujƒô siƒô bardziej zmƒôczony ni≈º dotychczas.", "Mƒôczƒô siƒô szybciej ni≈º zazwyczaj.", "Jestem tak zmƒôczony, ≈ºe nie mogƒô wykonywaƒá wielu zada≈Ñ, kt√≥re dotychczas wykonywa≈Çem.", "Jestem zbyt zmƒôczony  ≈ºeby wykonywaƒá wiƒôkszo≈õƒá czynno≈õci, kt√≥re dotychczas wykonywa≈Çem."]},
            {q: "Utrata zainteresowania seksem", o: ["Moje zainteresowanie seksem nie uleg≈Ço zmianie.", "Jestem mniej zainteresowany seksem ni≈º dotychczas.", "Jestem obecnie du≈ºo mniej zainteresowany seksem ni≈º dotychczas.", "Straci≈Çem ca≈Çkowite zainteresowanie seksem."]}
        ];
        genFormBDI('f-bdi', bQ, 'b');

        // LSAS (Leibowitz)
        const lQ = [
            "Rozmawianie przez telefon przy innych osobach", "Udzia≈Ç w ma≈Çej grupie (parƒô os√≥b)", "Jedzenie w miejscach publicznych", "Picie z innymi w miejscach publicznych", "Rozmowa z osobƒÖ na wy≈ºszym stanowisku", "Wystƒôpowanie/przemawianie przed publiczno≈õciƒÖ", "P√≥j≈õcie na imprezƒô", "Praca, gdy kto≈õ inny patrzy", "Pisanie, gdy kto≈õ inny patrzy", "Dzwonienie do kogo≈õ, kogo s≈Çabo znasz", "Rozmowa z kim≈õ, kogo s≈Çabo znasz", "Spotkanie z nieznajomymi", "Korzystanie z publicznej toalety", "Wej≈õcie do pokoju, w kt√≥rym siedzƒÖ ju≈º inni", "Bycie w centrum zainteresowania", "Zabranie g≈Çosu na spotkaniu", "PrzystƒÖpienie do testu wiedzy/umiejƒôtno≈õci", "Wyra≈ºenie niezgody osobie ma≈Ço znanej", "Patrzenie w oczy osobie ma≈Ço znanej", "Przygotowany referat wyg≈Çaszany przed grupƒÖ", "Pr√≥ba nawiƒÖzania bli≈ºszej relacji (podrywanie)", "Zwracanie towaru do sklepu", "Wydanie przyjƒôcia/imprezy", "Opieranie siƒô presji sprzedawcy"
        ];
        genFormLSAS('f-lsas', lQ, 'l');
        
        // CISS
        const cissQuestions = [
            "Lepiej planujƒô sw√≥j czas", "Koncentrujƒô siƒô na problemie i zastanawiam siƒô, jak mogƒô go rozwiƒÖzaƒá", "My≈õlƒô o czasach gdy by≈Ço mi lepiej", "Staram siƒô przebywaƒá z innymi lud≈∫mi", "Oskar≈ºam siƒô o zwlekanie", "Robiƒô to co uwa≈ºam za najlepsze", "Jestem skupiony(a) na swoich dolegliwo≈õciach fizycznych", "Winiƒô siebie, ≈ºe wpad≈Çem(am) w takƒÖ sytuacjƒô", "W≈Ç√≥czƒô siƒô po sklepach lub przeglƒÖdam oferty", "Ustalam, co w danej sytuacji jest najwa≈ºniejsze", "Staram siƒô zasnƒÖƒá", "Objadam siƒô ulubionƒÖ potrawƒÖ", "Niepokojƒô siƒô, ≈ºe sobie nie poradzƒô", "Stajƒô siƒô bardzo napiƒôty(a)", "My≈õlƒô o tym, jak rozwiƒÖzywa≈Çem(am) podobne problemy w przesz≈Ço≈õci", "Wmawiam sobie, ≈ºe to w rzeczywisto≈õci nie dzieje siƒô mnie", "Winiƒô siebie, ≈ºe zbyt siƒô tym przejmujƒô", "Idƒô co≈õ zje≈õƒá na mie≈õcie", "Staje siƒô bardzo przygnƒôbiony(a)", "Kupujƒô sobie co≈õ", "Wyznaczam sobie kierunek dzia≈Çania i postƒôpujƒô zgodnie z nim",
            "Obwiniam siebie za to, ≈ºe nie wiem co zrobiƒá", "Idƒô siƒô zabawiƒá", "Staram siƒô zrozumieƒá sytuacjƒô", "Zastygam w bezruchu i nie wiem co zrobiƒá", "Podejmujƒô natychmiast w≈Ça≈õciwe dzia≈Çanie", "Analizujƒô sytuacjƒô i uczƒô siƒô na w≈Çasnych b≈Çƒôdach", "≈ªa≈Çujƒô, ≈ºe nie mogƒô zmieniƒá tego co siƒô sta≈Ço, lub tego, co odczuwa≈Çem(am) w zwiƒÖzku z tym", "Odwiedzam przyjaciela", "Martwiƒô siƒô, jak sobie z tym poradzƒô", "Spƒôdzam czas z bliskƒÖ osobƒÖ", "Wychodzƒô na spacer", "Wmawiam sobie, ≈ºe to siƒô nigdy wiƒôcej nie powt√≥rzy", "Skupiam siƒô na swoich og√≥lnych brakach", "Rozmawiam z kim≈õ, kogo rady sobie ceniƒô", "Analizujƒô problem zanim zacznƒô dzia≈Çaƒá", "Dzwoniƒô do kolegi lub kole≈ºanki", "Wpadam w z≈Ço≈õƒá", "Zmieniam kolejno≈õƒá spraw do za≈Çatwienia", "OglƒÖdam film", "DƒÖ≈ºƒô do kontrolowania sytuacji", "Podejmujƒô dodatkowy wysi≈Çek, aby za≈Çatwiƒá sprawƒô", "Podchodzƒô do problemu z r√≥≈ºnych stron", "Robiƒô sobie wolnƒô, by uciec od problemu", "Wy≈Çadowujƒô siƒô na innych", "Wykorzystujƒô sytuacjƒô, aby udowodniƒá, ≈ºe potrafiƒô tego dokonaƒá", "Staram siƒô tak zorganizowaƒá sprawy, aby zapanowaƒá nad sytuacjƒÖ", "OglƒÖdam telewizjƒô"      
        ];
        genForm('f-ciss', cissQuestions, 5, 'ci', ["1", "2", "3", "4", "5"]);
    }

    function genForm(id, qs, n, prefix, labels=null) {
        const f = document.getElementById(id);
        f.innerHTML = qs.map((q, i) => `
            <div class="question-row">
                <span class="q-text">${i+1}. ${q}</span>
                <div class="options-group">
                    ${Array(n).fill(0).map((_, v) => `
                        <label class="opt-label">
                            <input type="radio" name="${prefix}${i}" value="${v}" required>
                            <span>${labels ? labels[v] : v}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function genFormBDI(id, questions, prefix) {
        const f = document.getElementById(id);
        f.innerHTML = questions.map((item, i) => `
            <div class="question-row">
                <span class="q-text">${i+1}. ${item.q}</span>
                <div class="options-group">
                    ${item.o.map((opt, v) => `
                        <label class="opt-label">
                            <input type="radio" name="${prefix}${i}" value="${v}" required>
                            <span>${opt}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    // Generator LSAS (Podw√≥jna punktacja)
    function genFormLSAS(id, qs, prefix) {
        const f = document.getElementById(id);
        f.innerHTML = qs.map((q, i) => `
            <div class="question-row">
                <span class="q-text">${i+1}. ${q}</span>
                <div class="lsas-label-mini">Lƒôk / Strach:</div>
                <div class="options-group">
                    ${["Brak", "≈Åagodny", "Umiark.", "Silny"].map((lbl, v) => `
                        <label class="opt-label">
                            <input type="radio" name="${prefix}f${i}" value="${v}" required>
                            <span>${lbl}</span>
                        </label>
                    `).join('')}
                </div>
                <div class="lsas-label-mini">Unikanie:</div>
                <div class="options-group">
                    ${["Nigdy", "Rzadko", "Czƒôsto", "Zawsze"].map((lbl, v) => `
                        <label class="opt-label">
                            <input type="radio" name="${prefix}a${i}" value="${v}" required>
                            <span>${lbl}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    /* --- FEATURE 4: AUTO SAVE & LOAD --- */
    function initAutoSave() {
        // Nas≈Çuchuj zmian na wszystkich inputach i textarea
        document.getElementById('dashboard').addEventListener('input', () => {
            saveData();
        });
        document.getElementById('dashboard').addEventListener('change', () => {
            saveData();
        });
    }

    function saveData() {
        const data = {};
        // Zapisz dane demograficzne
        data['p-init'] = document.getElementById('p-init').value;
        data['p-gender'] = document.getElementById('p-gender').value;
        data['p-age-group'] = document.getElementById('p-age-group').value;
        data['p-date'] = document.getElementById('p-date').value;

        // Zapisz radia
        document.querySelectorAll('input[type="radio"]:checked').forEach(r => {
            data[r.name] = r.value;
        });

        // Zapisz textareas (Kontrakt i Notatki)
        document.querySelectorAll('textarea, input[type="text"]').forEach(t => {
            if(t.id) data[t.id] = t.value;
        });

        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadProgress() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        try {
            const data = JSON.parse(raw);
            
            // Przywr√≥ƒá dane demograficzne
            if(data['p-init']) document.getElementById('p-init').value = data['p-init'];
            if(data['p-gender']) document.getElementById('p-gender').value = data['p-gender'];
            if(data['p-age-group']) document.getElementById('p-age-group').value = data['p-age-group'];
            if(data['p-date']) document.getElementById('p-date').value = data['p-date'];

            // Przywr√≥ƒá inputy tekstowe i textareas
            for (const [key, val] of Object.entries(data)) {
                const el = document.getElementById(key);
                if(el && (el.tagName === 'TEXTAREA' || el.type === 'text')) {
                    el.value = val;
                }
            }

            // Przywr√≥ƒá radia
            for (const [key, val] of Object.entries(data)) {
                const radios = document.getElementsByName(key);
                if(radios.length) {
                    radios.forEach(r => {
                        if(r.value === val) r.checked = true;
                    });
                }
            }
        } catch(e) {
            console.error("B≈ÇƒÖd odczytu zapisu", e);
        }
    }

    function clearData() {
        if(confirm("Czy na pewno chcesz wyczy≈õciƒá wszystkie dane i odpowiedzi?")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    function calculateCurrent() {
        const activeSection = document.querySelector('.test-section.active');
        const activeId = activeSection.id;

        if(activeId === 't-contract') {
            const shouldPrint = confirm("Kontrakt na ≈ºycie nie wymaga oblicze≈Ñ. Czy chcesz go wydrukowaƒá?");
            if(shouldPrint) window.print();
            return;
        }

        const inputs = activeSection.querySelectorAll('input[type="radio"]');
        const names = [...new Set([...inputs].map(i => i.name))];
        const checked = activeSection.querySelectorAll('input:checked');
        if(checked.length < names.length) {
            alert("Proszƒô odpowiedzieƒá na wszystkie pytania w tej sekcji!");
            return;
        }

        if(activeId === 't-dass') calcDASS();
        else if(activeId === 't-dass42') calcD42();
        else if(activeId === 't-dassy') calcDassy();
        else if(activeId === 't-phq9') calcPHQ();
        else if(activeId === 't-gad7') calcGAD();
        else if(activeId === 't-bdi') calcBDI();
        else if(activeId === 't-lsas') calcLSAS();
        else if(activeId === 't-ciss') calcCISS();
    }

    function calcDASS() {
        const getSum = (idx) => {
            let s = 0;
            idx.forEach(i => {
                const r = document.querySelector(`input[name="d${i}"]:checked`);
                if(r) s += parseInt(r.value);
            });
            return s * 2;
        };
        const d = getSum([2,4,9,12,15,16,20]);
        const a = getSum([1,3,6,8,14,18,19]);
        const s = getSum([0,5,7,10,11,13,17]);
        const interp = (v, th) => v<=th[0]?"Norma":v<=th[1]?"≈Åagodny":v<=th[2]?"Umiarkowany":v<=th[3]?"Silny":"B. Silny";
        
        document.getElementById('res-dass').innerHTML = `
            <h3>Wyniki DASS-21:</h3>
            <div class="res-line">Depresja: <span>${d} - ${interp(d, [9,13,20,27])}</span></div>
            <div class="res-line">Lƒôk: <span>${a} - ${interp(a, [7,9,14,19])}</span></div>
            <div class="res-line">Stres: <span>${s} - ${interp(s, [14,18,25,33])}</span></div>
        `;
        document.getElementById('res-dass').style.display = 'block';
    }

    function calcD42() {
        const getSum = (idx) => {
            let s = 0;
            idx.forEach(i => { const r = document.querySelector(`input[name="d42${i}"]:checked`); if(r) s += parseInt(r.value); });
            return s;
        };
        const d = getSum([2,4,9,12,15,16,20,23,25,30,33,35,36,40]);
        const a = getSum([1,3,6,8,14,18,19,22,24,27,29,34,38,39]);
        const s = getSum([0,5,7,10,11,13,17,21,26,28,31,32,37,41]);
        renderDassRes('res-dass42', d, a, s, true);
    }

    function calcDassy() {
        const getSum = (idx) => {
            let s = 0;
            idx.forEach(i => { const r = document.querySelector(`input[name="dy${i}"]:checked`); if(r) s += parseInt(r.value); });
            return s;
        };
        const d = getSum([2,4,9,12,15,16,20]), a = getSum([1,3,6,8,14,18,19]), s = getSum([0,5,7,10,11,13,17]);
        renderDassRes('res-dassy', d, a, s, false, true);
    }

    function renderDassRes(id, d, a, s, isFull=false, isDassy=false) {
        const interp = (v, th) => v<=th[0]?"Norma":v<=th[1]?"≈Åagodny":v<=th[2]?"Umiarkowany":v<=th[3]?"Silny":"B. Silny";
        const thD = [6,8,13,16]; 
        const thA = [5,7,12,15];
        const thS = [11,13,16,18];
        document.getElementById(id).innerHTML = `
            <h3>Wyniki ${isDassy?'DASSY':(isFull?'DASS-42':'DASS-21')}:</h3>
            <div class="res-line">Depresja: <span>${d} - ${interp(d, thD)}</span></div>
            <div class="res-line">Lƒôk: <span>${a} - ${interp(a, thA)}</span></div>
            <div class="res-line">Stres: <span>${s} - ${interp(s, thS)}</span></div>
        `;
        document.getElementById(id).style.display = 'block';
    }

    function calcPHQ() {
        let sum = 0;
        document.querySelectorAll('#f-phq9 input:checked').forEach(i => sum += parseInt(i.value));
        const txt = sum<=4?"Norma":sum<=9?"≈Åagodna":sum<=14?"Umiarkowana":sum<=19?"Umiarkowanie ciƒô≈ºka":"Ciƒô≈ºka";
        
        let warning = "";
        // Feature 3: Check item 9 (index 8) for suicide risk
        const riskItem = document.querySelector('input[name="p8"]:checked');
        if(riskItem && parseInt(riskItem.value) > 0) {
            warning = `<div class="alert-box">‚ö†Ô∏è UWAGA: Pacjent zg≈Çosi≈Ç my≈õli samob√≥jcze (Pyt. 9).</div>`;
        }

        document.getElementById('res-phq9').innerHTML = `<h3>Suma PHQ-9: ${sum}</h3><p>Interpretacja: ${txt}</p>${warning}`;
        document.getElementById('res-phq9').style.display = 'block';
    }

    function calcGAD() {
        let sum = 0;
        document.querySelectorAll('#f-gad7 input:checked').forEach(i => sum += parseInt(i.value));
        const txt = sum<=4?"Norma":sum<=9?"≈Åagodny":sum<=14?"Umiarkowany":"Silny";
        document.getElementById('res-gad7').innerHTML = `<h3>Suma GAD-7: ${sum}</h3><p>Interpretacja: ${txt}</p>`;
        document.getElementById('res-gad7').style.display = 'block';
    }

    function calcBDI() {
        let sum = 0;
        document.querySelectorAll('#f-bdi input:checked').forEach(i => sum += parseInt(i.value));
        let interpretation = sum <= 13 ? "Minimalna" : sum <= 19 ? "≈Åagodna" : sum <= 28 ? "Umiarkowana" : "Ciƒô≈ºka";
        
        let warning = "";
        // Feature 3: Check item 9 (index 8) for suicide risk in BDI
        const riskItem = document.querySelector('input[name="b8"]:checked');
        if(riskItem && parseInt(riskItem.value) > 0) {
            warning = `<div class="alert-box">‚ö†Ô∏è UWAGA: Pacjent zg≈Çosi≈Ç my≈õli samob√≥jcze (Pyt. 9).</div>`;
        }

        document.getElementById('res-bdi').innerHTML = `<h3>Suma BDI-II: ${sum} pkt</h3><p>Interpretacja: ${interpretation} depresja.</p>${warning}`;
        document.getElementById('res-bdi').style.display = 'block';
    }

    function calcLSAS() {
        let fSum = 0, aSum = 0;
        document.querySelectorAll('#f-lsas input[name^="lf"]:checked').forEach(i => fSum += parseInt(i.value));
        document.querySelectorAll('#f-lsas input[name^="la"]:checked').forEach(i => aSum += parseInt(i.value));
        const total = fSum + aSum;
        const interp = total <= 54 ? "Brak fobii" : total <= 65 ? "≈Åagodna" : total <= 80 ? "Umiarkowana" : total <= 95 ? "Nasilona" : "Bardzo silna";
        document.getElementById('res-lsas').innerHTML = `
            <h3>LSAS: ${total} pkt</h3>
            <div class="res-line">Lƒôk (suma): <span>${fSum}</span></div>
            <div class="res-line">Unikanie (suma): <span>${aSum}</span></div>
            <div class="res-line">Interpretacja: <span>${interp}</span></div>
        `;
        document.getElementById('res-lsas').style.display = 'block';
    }

    function calcCISS() {
        const ageGroup = document.getElementById('p-age-group').value;
        const key = {
            ssz: [0, 1, 5, 9, 14, 20, 23, 25, 26, 35, 38, 40, 41, 42, 44, 46],
            sse: [4, 6, 7, 12, 13, 15, 16, 18, 21, 24, 27, 29, 32, 33, 37, 44],
            ssu: [2, 3, 8, 10, 11, 17, 19, 22, 28, 30, 31, 34, 36, 39, 43, 47]
        };
    
        const getScore = (indices) => {
            let sum = 0;
            indices.forEach(idx => {
                const r = document.querySelector(`input[name="ci${idx}"]:checked`);
                if(r) sum += (parseInt(r.value) + 1);
            });
            return sum;
        };
    
        const raw = { ssz: getScore(key.ssz), sse: getScore(key.sse), ssu: getScore(key.ssu) };
        
        // Normy uproszczone/przyk≈Çadowe
        const norms = {
            '16-24': {
                ssz: [30, 39, 47, 52, 57, 61, 65, 68, 73],
                sse: [21, 26, 32, 37, 42, 50, 55, 61, 69],
                ssu: [30, 34, 39, 44, 50, 54, 59, 64, 68]
            },
            '25-54': {
                ssz: [38, 43, 48, 52, 57, 61, 65, 68, 74], 
                sse: [24, 30, 35, 39, 43, 51, 55, 60, 64],
                ssu: [27, 30, 34, 38, 43, 47, 52, 56, 61]
            },
            '55-79': {
                ssz: [37, 42, 46, 50, 55, 60, 64, 68, 72],
                sse: [26, 31, 36, 41, 45, 50, 56, 62, 69],
                ssu: [25, 31, 35, 38, 44, 49, 53, 57, 61]
            }
        };

        const calculateSten = (score, scaleNorms) => {
            for (let i = 0; i < scaleNorms.length; i++) {
                if (score <= scaleNorms[i]) return i + 1;
            }
            return 10;
        };

        const stens = {
            ssz: calculateSten(raw.ssz, norms[ageGroup].ssz),
            sse: calculateSten(raw.sse, norms[ageGroup].sse),
            ssu: calculateSten(raw.ssu, norms[ageGroup].ssu)
        };

        const getInterp = (s) => s <= 3 ? "Niski" : s <= 7 ? "Przeciƒôtny" : "Wysoki";

        document.getElementById('res-ciss').innerHTML = `
            <h3>Wyniki CISS (Grupa wiekowa: ${ageGroup}):</h3>
            <table style="width:100%; border-collapse: collapse; margin-top:10px;">
                <tr><th>Skala</th><th>Surowy</th><th>Sten</th><th>Interpretacja</th></tr>
                <tr><td>Zadanie (SSZ)</td><td>${raw.ssz}</td><td>${stens.ssz}</td><td>${getInterp(stens.ssz)}</td></tr>
                <tr><td>Emocje (SSE)</td><td>${raw.sse}</td><td>${stens.sse}</td><td>${getInterp(stens.sse)}</td></tr>
                <tr><td>Unikanie (SSU)</td><td>${raw.ssu}</td><td>${stens.ssu}</td><td>${getInterp(stens.ssu)}</td></tr>
            </table>
        `;
        document.getElementById('res-ciss').style.display = 'block';
    }

    /* --- FEATURE 1: PDF EXPORT --- */
    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Helper to map PL chars to ASCII for PDF basic font support
        const plMap = {'ƒÖ':'a', 'ƒá':'c', 'ƒô':'e', '≈Ç':'l', '≈Ñ':'n', '√≥':'o', '≈õ':'s', '≈∫':'z', '≈º':'z', 'ƒÑ':'A', 'ƒÜ':'C', 'ƒò':'E', '≈Å':'L', '≈É':'N', '√ì':'O', '≈ö':'S', '≈π':'Z', '≈ª':'Z'};
        const toAscii = (str) => str.split('').map(c => plMap[c] || c).join('');

        const activeSec = document.querySelector('.test-section.active');
        if(!activeSec) return;
        const testName = activeSec.querySelector('h2').innerText;
        const resultDiv = activeSec.querySelector('.result-panel');
        const notes = activeSec.querySelector('textarea[id^="note-"]').value;

        // Header
        doc.setFontSize(16);
        doc.text("Raport Diagnostyczny", 10, 10);
        
        doc.setFontSize(12);
        doc.text("Pacjent: " + toAscii(document.getElementById('p-init').value), 10, 20);
        doc.text("Data: " + document.getElementById('p-date').value, 10, 26);
        doc.text("Test: " + toAscii(testName), 10, 32);

        // Results
        if(resultDiv && resultDiv.style.display !== 'none') {
            doc.text("WYNIKI:", 10, 45);
            let y = 52;
            const lines = resultDiv.innerText.split('\n');
            lines.forEach(l => {
                if(l.trim()) {
                    doc.text(toAscii(l.trim()), 10, y);
                    y += 6;
                }
            });
            
            // Notes
            if(notes) {
                y += 10;
                doc.text("NOTATKI KLINICZNE:", 10, y);
                const splitNotes = doc.splitTextToSize(toAscii(notes), 180);
                doc.text(splitNotes, 10, y + 6);
            }
        } else if (activeSec.id === 't-contract') {
             doc.text("KONTRAKT NA ZYCIE - WYDRUK UPROSZCZONY", 10, 45);
             doc.text("Zaleca sie uzycie systemowej opcji DRUKUJ dla kontraktu.", 10, 55);
        } else {
            doc.text("Brak obliczonych wynikow. Kliknij 'Oblicz wynik'.", 10, 45);
        }

        doc.save(`Raport_${toAscii(testName)}.pdf`);
    }

    /* --- FEATURE 9: CSV EXPORT --- */
    function exportCSV() {
        let csv = "Sekcja,Pytanie/Pole,Odpowiedz\n";
        
        // Dane pacjenta
        csv += `Pacjent,Inicjaly,${document.getElementById('p-init').value}\n`;
        csv += `Pacjent,Data,${document.getElementById('p-date').value}\n`;

        // Iteracja przez aktywne inputy
        document.querySelectorAll('.test-section').forEach(sec => {
            const secName = sec.querySelector('h2').innerText;
            
            // Radio buttons
            sec.querySelectorAll('.question-row').forEach(row => {
                const qText = row.querySelector('.q-text') ? row.querySelector('.q-text').innerText.replace(/,/g, ' ') : "Pytanie";
                const checked = row.querySelector('input:checked');
                if(checked) {
                    csv += `${secName},"${qText}",${checked.value}\n`;
                }
            });

            // Text areas
            sec.querySelectorAll('textarea').forEach(txt => {
                if(txt.value) {
                    const label = txt.previousElementSibling ? txt.previousElementSibling.innerText : "Pole tekstowe";
                    csv += `${secName},"${label.replace(/,/g, ' ')}","${txt.value.replace(/\n/g, ' ').replace(/"/g, '""')}"\n`;
                }
            });
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `Wyniki_${document.getElementById('p-init').value || 'Pacjent'}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        }
       function initSignaturePads() {
    const canvases = document.querySelectorAll('.sig-canvas');
    canvases.forEach(canvas => {
        const ctx = canvas.getContext('2d');
        let drawing = false;

        const getPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) * (canvas.width / rect.width),
                y: (clientY - rect.top) * (canvas.height / rect.height)
            };
        };

        const draw = (e) => {
            if (!drawing) return;
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            e.preventDefault();
        };

        canvas.addEventListener('mousedown', (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); });
        canvas.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', () => { if(drawing) { drawing = false; saveSignatures(); } });

        canvas.addEventListener('touchstart', (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); }, {passive: false});
        canvas.addEventListener('touchmove', draw, {passive: false});
        canvas.addEventListener('touchend', () => { drawing = false; saveSignatures(); });

        ctx.lineWidth = 2; ctx.lineCap = "round"; ctx.strokeStyle = "#000";
    });
}

function clearCanvas(id) {
    const canvas = document.getElementById(id);
    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    saveSignatures();
}

// Zapisywanie podpis√≥w jako obrazy Base64 w localStorage
function saveSignatures() {
    const sigs = {};
    document.querySelectorAll('.sig-canvas').forEach(canvas => {
        sigs[canvas.id] = canvas.toDataURL();
    });
    localStorage.setItem('saved_signatures', JSON.stringify(sigs));
}

// Odczytywanie podpis√≥w po od≈õwie≈ºeniu
function loadSignatures() {
    const saved = localStorage.getItem('saved_signatures');
    if (!saved) return;
    const sigs = JSON.parse(saved);
    for (let id in sigs) {
        const canvas = document.getElementById(id);
        if (canvas) {
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0);
            img.src = sigs[id];
        }
    }
}
    function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    // Zapisz preferencjƒô u≈ºytkownika w localStorage
    const isDark = document.body.classList.contains('dark-mode');
    localStorage.setItem('darkMode', isDark);
}

// Sprawd≈∫ zapisanƒÖ preferencjƒô przy ≈Çadowaniu strony
window.addEventListener('load', () => {
    if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
    }
});

</script>

</body>
</html>
