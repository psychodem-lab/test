<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Psychologa - System Diagnostyczny</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --border: #e2e8f0;
            --accent: #4f46e5;
            --danger: #dc2626;
            --warning-bg: #fef2f2;
        }

        /* --- Global Reset & Mobile --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.5;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Login Screen --- */
        #login-screen {
            position: fixed;
            inset: 0; background: var(--bg);
            display: flex; align-items: center; justify-content: center; z-index: 2000;
            padding: 20px;
        }
        .login-card {
            background: var(--surface);
            padding: 2rem; border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 400px;
            text-align: center;
        }
        .login-card h2 { margin-bottom: 1.5rem; }
        .login-card input {
            width: 100%;
            padding: 0.8rem; margin-bottom: 1rem;
            border: 1px solid var(--border); border-radius: 8px; font-size: 1rem;
        }

        /* --- Dashboard Layout --- */
        #dashboard { display: none; padding: 1rem; max-width: 900px; margin: 0 auto; padding-bottom: 80px; }
        
        header {
            background: var(--surface);
            padding: 1.5rem; border-radius: 12px;
            margin-bottom: 1rem; border: 1px solid var(--border);
        }
        .patient-data {
            display: grid;
            grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 1rem;
        }
        input[type="text"], input[type="date"], select {
            width: 100%;
            padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px;
            font-family: inherit; font-size: 0.9rem;
        }

        /* --- Tabs --- */
        .nav-tabs {
            display: flex;
            gap: 8px; overflow-x: auto; padding-bottom: 8px;
            margin-bottom: 1.5rem; scrollbar-width: none;
        }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .tab-link {
            flex: 0 0 auto;
            background: var(--surface); border: 1px solid var(--border);
            padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem;
            font-weight: 500; transition: 0.2s;
        }
        .tab-link.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- Test Content --- */
        .test-section { display: none;
            background: var(--surface); border-radius: 12px; padding: 1.5rem; border: 1px solid var(--border);
        }
        .test-section.active { display: block; }
        .test-header { margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
        .test-header h2 { font-size: 1.25rem; }
        .test-header p { font-size: 0.85rem; color: var(--muted); margin-top: 4px; }

        /* --- Question UI --- */
        .question-row { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px outline var(--bg); }
        .q-text { font-weight: 500; display: block; margin-bottom: 0.75rem; font-size: 0.95rem; }
        .options-group { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .opt-label {
            flex: 1;
            min-width: 60px; display: flex; flex-direction: column; align-items: center;
            padding: 10px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer;
            font-size: 0.8rem;
            transition: 0.2s; text-align: center;
        }
        .opt-label:hover { background: #f1f5f9; }
        .opt-label input { margin-bottom: 4px; }
        .opt-label.selected { background: #e0e7ff; border-color: var(--primary); }

        /* --- Result Styling --- */
        .result-panel {
            margin-top: 2rem;
            padding: 1.5rem; background: #f1f5f9; border-radius: 8px;
            border-left: 4px solid var(--primary); display: none;
        }
        .res-line { display: flex; justify-content: space-between; margin-bottom: 0.4rem; padding: 5px 0; border-bottom: 1px solid #e2e8f0; }
        .res-line span { font-weight: bold; }

        /* --- Critical Alert Box (Feature 3) --- */
        .alert-box {
            margin-top: 1rem;
            padding: 1rem;
            background-color: var(--warning-bg);
            border: 2px solid var(--danger);
            border-radius: 8px;
            color: var(--danger);
            font-weight: bold;
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
        }

        /* --- Notes Section (Feature 7) --- */
        .clinician-notes-area {
            margin-top: 2rem;
            border-top: 2px dashed var(--border);
            padding-top: 1.5rem;
        }
        .clinician-notes-area label {
            font-weight: 600; font-size: 0.9rem; color: var(--muted); display: block; margin-bottom: 0.5rem;
        }
        .clinician-notes-area textarea {
            width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px;
            font-family: inherit; font-size: 0.9rem; resize: vertical; min-height: 80px;
            background: #fffff0; /* Light yellow to distinguish notes */
        }

        /* --- Action Buttons --- */
        .actions {
            position: fixed;
            bottom: 0; left: 0; right: 0; 
            display: flex; gap: 10px; justify-content: center; padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid var(--border);
            backdrop-filter: blur(5px);
            z-index: 1000;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 30px; border: none; font-weight: 600;
            cursor: pointer; font-size: 0.85rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.95); }
        .btn-calc { background: var(--accent); color: white; }
        .btn-print { background: #10b981; color: white; }
        .btn-pdf { background: #ea580c; color: white; } /* Orange for PDF */
        .btn-csv { background: #0891b2; color: white; } /* Cyan for CSV */
        .btn-clear { background: #64748b; color: white; font-size: 0.75rem; padding: 8px 16px;}

        /* --- CONTRACT STYLES --- */
        textarea.contract-input {
            width: 100%; padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px;
            font-family: inherit; font-size: 0.95rem; resize: vertical; margin-top: 5px; margin-bottom: 10px;
        }
        .contract-agreement {
            background: #f1f5f9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid var(--primary);
        }
        .sig-line {
            margin-top: 10px; border-top: 1px dashed var(--muted); padding-top: 5px;
        }
        .sig-container {
            margin-top: 10px;
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }
        .sig-canvas {
            display: block;
            width: 100%; /* Dopasuje się do szerokości ekranu */
            height: 150px;
            cursor: crosshair;
            touch-action: none; /* Kluczowe dla urządzeń mobilnych - blokuje przewijanie podczas podpisu */
        }
        .sig-actions {
            background: #f8fafc;
            padding: 5px 10px;
            text-align: right;
            border-top: 1px solid var(--border);
        }
        .btn-clear-sig {
            background: none;
            border: none;
            color: var(--danger);
            font-size: 0.7rem;
            cursor: pointer;
            font-weight: 600;
        }

        /* --- PRINT STYLES --- */
        @media print {
            body { background: white; padding-bottom: 0; }
            #login-screen, .nav-tabs, .actions, .btn-calc, header h1, .btn-clear { display: none !important; }
            #dashboard { display: block !important; padding: 0; width: 100%; padding-bottom: 0; }
            .test-section { display: none !important; }
            .test-section.active { display: block !important; border: none !important; }
            .result-panel { display: block !important; background: white !important; border: 1px solid #000 !important; }
            input, textarea { border: none !important; font-weight: bold; font-family: 'Times New Roman', serif; }
            textarea { resize: none; overflow: visible; height: auto; }
            .contract-agreement { border: 1px solid #ccc; background: white; }
            .clinician-notes-area { border-top: 1px solid black; }
            .clinician-notes-area textarea { background: white; border: none; }
        }

        @media (max-width: 600px) {
            .options-group { display: grid; grid-template-columns: 1fr; }
            .opt-label { flex-direction: row; gap: 10px; text-align: left; }
            .actions { padding: 10px; gap: 5px; }
            .btn { flex: 1; text-align: center; padding: 10px 5px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h2>Panel Psychologa</h2>
        <input type="password" id="pass" placeholder="Hasło">
        <button class="btn btn-calc" style="width:100%" onclick="login()">Zaloguj się</button>
    </div>
</div>

<div id="dashboard">
    <header>
        <h1>System Diagnostyczny</h1>
        <div class="patient-data">
            <div>
                <label style="font-size:0.7rem; color:var(--muted)">Inicjały Pacjenta</label>
                <input type="text" id="p-init" placeholder="np. A.B.">
            </div>
            <div>
                <label style="font-size:0.7rem; color:var(--muted)">Płeć</label>
                <select id="p-gender">
                    <option value="K">Kobieta</option>
                    <option value="M">Mężczyzna</option>
                </select>
            </div>
            <div>
                <label style="font-size:0.7rem; color:var(--muted)">Grupa wiekowa</label>
                <select id="p-age-group">
                    <option value="16-24">16 - 24 lata</option>
                    <option value="25-54">25 - 54 lata</option>
                    <option value="55-79">55 - 79 lat</option>
                </select>
            </div>
            <div>
                <label style="font-size:0.7rem; color:var(--muted)">Data badania</label>
                <input type="date" id="p-date">
            </div>
        </div>
    </header>

    <nav class="nav-tabs">
        <button class="tab-link active" onclick="openTab(event, 't-dass')">DASS-21</button>
        <button class="tab-link" onclick="openTab(event, 't-dass42')">DASS-42</button>
        <button class="tab-link" onclick="openTab(event, 't-dassy')">DASSY (Dzieci)</button>
        <button class="tab-link" onclick="openTab(event, 't-bdi')">BDI-II</button>
        <button class="tab-link" onclick="openTab(event, 't-lsas')">LSAS</button>
        <button class="tab-link" onclick="openTab(event, 't-ciss')">CISS</button>
        <button class="tab-link" onclick="openTab(event, 't-contract')">Kontrakt na życie</button>
    </nav>

    <div id="t-dass" class="test-section active">
        <div class="test-header">
            <h2>DASS-21</h2>
            <p>Skala Depresji, Lęku i Stresu (0 - wcale, 3 - bardzo często).</p>
        </div>
        <form id="f-dass"></form>
        <div id="res-dass" class="result-panel"></div>
        <div class="clinician-notes-area">
            <label>Notatki kliniczne / Obserwacje:</label>
            <textarea id="note-dass" placeholder="Wpisz obserwacje dot. pacjenta..."></textarea>
        </div>
    </div>

    <div id="t-dass42" class="test-section">
        <div class="test-header"><h2>DASS-42</h2><p>Pełna Skala Depresji, Lęku i Stresu.</p></div>
        <form id="f-dass42"></form><div id="res-dass42" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-dass42"></textarea></div>
    </div>

    <div id="t-dassy" class="test-section">
        <div class="test-header"><h2>DASSY</h2><p>Skala dla dzieci i młodzieży.</p></div>
        <form id="f-dassy"></form><div id="res-dassy" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-dassy"></textarea></div>
    </div>

    <div id="t-phq9" class="test-section">
        <div class="test-header"><h2>PHQ-9</h2><p>Kwestionariusz Zdrowia Pacjenta.</p></div>
        <form id="f-phq9"></form><div id="res-phq9" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-phq9"></textarea></div>
    </div>

    <div id="t-gad7" class="test-section">
        <div class="test-header"><h2>GAD-7</h2><p>Skala Lęku Uogólnionego.</p></div>
        <form id="f-gad7"></form><div id="res-gad7" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-gad7"></textarea></div>
    </div>

    <div id="t-bdi" class="test-section">
        <div class="test-header"><h2>BDI-II</h2><p>Inwentarz Depresji Becka.</p></div>
        <form id="f-bdi"></form><div id="res-bdi" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-bdi"></textarea></div>
    </div>

    <div id="t-lsas" class="test-section">
        <div class="test-header"><h2>LSAS (Leibowitz)</h2><p>Ocena lęku społecznego.</p></div>
        <form id="f-lsas"></form><div id="res-lsas" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-lsas"></textarea></div>
    </div>

    <div id="t-ciss" class="test-section">
        <div class="test-header">
            <h2>CISS</h2>
            <p>Radzenie Sobie w Sytuacjach Stresowych (1 - nigdy, 5 - bardzo często).</p>
        </div>
        <form id="f-ciss"></form>
        <div id="res-ciss" class="result-panel"></div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-ciss"></textarea></div>
    </div>

    <div id="t-contract" class="test-section">
        <div class="test-header">
            <h2>Kontrakt na życie</h2>
            <p>Plan bezpieczeństwa i umowa terapeutyczna.</p>
        </div>

        <div class="question-row">
            <label><strong>Miejscowość i data:</strong></label>
            <input type="text" id="cnt-loc" placeholder="Wpisz miejscowość i datę">
        </div>

        <div style="margin-bottom: 2rem; line-height: 1.6; font-size: 0.95rem;">
            <p>Kiedy czujemy się przygnębieni, możemy myśleć o zadawaniu sobie bólu lub nawet zabiciu siebie. Faktycznie, myśli samobójcze są jednym z możliwych objawów depresji. Takie myśli czy impulsy mogą się zdarzyć, ale bardzo ważne jest to, żebyśmy mogli o nich rozmawiać. Najważniejsze jest twoje bezpieczeństwo. Dlatego będziemy rozmawiać o różnych trudnych sprawach, nawet o chęci odebrania sobie życia. Za chwilę umówimy się, że będziemy robić wszystko, żeby poradzić sobie w trudnej sytuacji. W umowie przyjrzymy się, kiedy miałeś/aś myśli samobójcze w przeszłości, jakiego rodzaju myśli pomogły Ci je przezwyciężyć i stworzymy plan reagowania w sytuacjach, kiedy takie myśli i impulsy pojawia się podczas trwania naszej wspólnej pracy.</p>
        </div>

        <div class="question-row">
            <label class="q-text">Proszę opisz sytuację, jeżeli taka istnieje, w której poczułaś impuls do popełnienia samobójstwa w ostatnim okresie. Jeśli było ich kilka, pomyśl o najgorszej z nich.</label>
            <textarea id="cnt-q1" class="contract-input" rows="3"></textarea>
        </div>

        <h3>Co umożliwiło Ci poczuć się lepiej w ostatnim czasie?</h3>
        
        <div class="question-row">
            <label class="q-text">Jakie myśli pozwoliły Ci poczuć się lepiej?</label>
            <textarea id="cnt-q2" class="contract-input" rows="2"></textarea>
        </div>
        <div class="question-row">
            <label class="q-text">Jacy ludzie pomogli Ci poczuć się lepiej?</label>
            <textarea id="cnt-q3" class="contract-input" rows="2"></textarea>
        </div>
        <div class="question-row">
            <label class="q-text">Czy coś z rzeczy, które robiłeś/aś pomogło Ci poczuć się lepiej?</label>
            <textarea id="cnt-q4" class="contract-input" rows="2"></textarea>
        </div>

        <h3>Co prawdopodobnie mogłoby Ci pomóc, gdybyś zaczął/ęła mieć myśli samobójcze?</h3>

        <div class="question-row">
            <label class="q-text">Jakie myśli mogłyby Ci pomóc, aby przezwyciężyć samobójcze myśli lub impulsy?</label>
            <textarea id="cnt-q5" class="contract-input" rows="2"></textarea>
        </div>
        <div class="question-row">
            <label class="q-text">Jakich ludzi mógłbyś /mogłabyś w to włączyć?</label>
            <textarea id="cnt-q6" class="contract-input" rows="2"></textarea>
        </div>
        <div class="question-row">
            <label class="q-text">Jaki może być plan działania, jeśli będziesz mieć myśli lub impulsy samobójcze?</label>
            <textarea id="cnt-q7" class="contract-input" rows="3"></textarea>
        </div>

        <hr style="margin: 2rem 0; border: 0; border-top: 1px solid var(--border);">

        <div class="contract-agreement">
            <p>Obiecuję że nie popełnię samobójstwa i będę rozmawiał/a o myślach i tendencjach samobójczych z lekarzem/psychologiem/terapeutą/pracownikiem socjalnym.</p>
                        <div class="sig-container">
                <canvas id="canvas-sig1" class="sig-canvas" width="400" height="150"></canvas>
                <div class="sig-actions">
                    <button type="button" class="btn-clear-sig" onclick="clearCanvas('canvas-sig1')">Wyczyść podpis</button>
                </div>
            </div>
            
        </div>

        <div class="contract-agreement">
            <p>Obiecuję że powiem innym dorosłym, że bardzo źle się czuję i poproszę, żeby zawiadomili mojego lekarza/terapeutę.</p>
            <div class="sig-line">
                <label style="font-size: 0.85rem; color: var(--muted);">Zgoda (podpis):</label>
                <input type="text" id="cnt-sig2" placeholder="Podpis pacjenta">
            </div>
        </div>

        <div class="contract-agreement">
            <p>Obiecuję, że jeżeli nikogo nie będzie w pobliżu, to w przypadku ostrych myśli samobójczych sam/a zgłoszę się na ostry dyżur do szpitala.</p>
            <div class="sig-line">
                <label style="font-size: 0.85rem; color: var(--muted);">Zgoda (podpis):</label>
                <input type="text" id="cnt-sig3" placeholder="Podpis pacjenta">
            </div>
        </div>

        <div class="contract-agreement">
            <p>Obiecuję że nie posiadam dostępu do broni ani innych zabójczych środków.</p>
            <div class="sig-line">
                <label style="font-size: 0.85rem; color: var(--muted);">Zgoda (podpis):</label>
                <input type="text" id="cnt-sig4" placeholder="Podpis pacjenta">
            </div>
        </div>

        <div class="question-row" style="margin-top: 2rem;">
            <label><strong>Podpis osoby pomagającej:</strong></label>
            <input type="text" id="cnt-therapist" style="margin-top: 5px;">
        </div>
        <div class="clinician-notes-area"><label>Notatki:</label><textarea id="note-contract"></textarea></div>
    </div>

    <div class="actions">
        <button class="btn btn-calc" onclick="calculateCurrent()">Oblicz wynik</button>
        <button class="btn btn-print" onclick="window.print()">Drukuj (Pełny)</button>
        <button class="btn btn-pdf" onclick="exportPDF()">Eksport PDF</button>
        <button class="btn btn-csv" onclick="exportCSV()">Eksport CSV (Excel)</button>
        <button class="btn btn-clear" onclick="clearData()">Wyczyść dane</button>
    </div>
</div>

<script>
    const PASS = "psy26";
    // Feature 4: LocalStorage Key
    const STORAGE_KEY = 'psy_panel_data_v1';

    function login() {
        if(document.getElementById('pass').value === PASS) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            document.getElementById('p-date').valueAsDate = new Date();
            initTests();
            loadProgress(); // Feature 4: Load Data
            initAutoSave(); // Feature 4: Init Saver
        } else alert("Błędne hasło");
    }

    function openTab(evt, id) {
        document.querySelectorAll('.test-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-link').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        evt.currentTarget.classList.add('active');
        window.scrollTo(0,0);
    }

    function initTests() {
        // DASS-21
        const dQ = ["Trudno było mi się uspokoić", "Czułem(am) suchość w ustach", "Nie potrafiłem(am) odczuwać żadnych pozytywnych uczuć", "Miałem(am) trudności z oddychaniem (np. szybki oddech)", "Trudno było mi nabrać inicjatywy do działania", "Miałem(am) tendencję do przesadnego reagowania", "Czułem(am) drżenie (np. rąk)", "Czułem(am), że zużywam dużo nerwowej energii", "Martwiłem(am) się sytuacjami, w których mogę wpaść w panikę", "Czułem(am), że nie mam na co czekać w przyszłości", "Czułem(am), że staję się poddenerwowany(a)", "Trudno było mi się zrelaksować", "Czułem(am) się przygnębiony(a) i smutny(a)", "Nie tolerowałem(am) niczego, co przeszkadzało mi w działaniu", "Czułem(am), że jestem bliski(a) paniki","Nie potrafiłem(am) się niczym entuzjazmować", "Czułem(am), że nie jestem wiele wart(a)", "Czułem(am), że jestem przewrażliwiony(a)", "Byłem(am) świadomy(a) rytmu serca bez wysiłku", "Czułem(am) się wystraszony(a) bez powodu", "Czułem(am), że życie nie ma sensu"];
        genForm('f-dass', dQ, 4, 'd');

        // DASS-42
        const d42Q = [
            "Trudno było mi się uspokoić", "Czułem suchość w ustach", "Nie potrafiłem odczuwać pozytywnych uczuć", "Trudności z oddychaniem", "Trudno mi było zacząć jakąś czynność", "Przesadnie reagowałem na sytuacje", "Czułem drżenie (np. rąk)", "Czułem, że zużywam dużo energii", "Bałem się sytuacji paniki", "Nie miałem na co czekać", "Stawałem się poddenerwowany", "Trudno mi było się zrelaksować", "Czułem się przygnębiony", "Nie tolerowałem przeszkód", "Czułem, że jestem bliski paniki", "Brak entuzjazmu", "Czułem, że nie jestem wiele wart", "Byłem przewrażliwiony", "Świadomość rytmu serca", "Bałem się bez powodu", "Czułem, że życie nie ma sensu", "Trudno mi było się odprężyć", "Problemy z połykaniem", "Brak radości z czegokolwiek", "Świadomość bicia serca", "Czułem smutek i przygnębienie", "Byłem bardzo drażliwy", "Byłem bliski paniki", "Trudno mi było się wyciszyć", "Bałem się, że coś mnie przerazi", "Brak entuzjazmu dla planów", "Trudno mi było zacząć działanie", "Czułem, że jestem do niczego", "Byłem nietolerancyjny", "Czułem brak tchu", "Czułem brak nadziei", "Życie wydawało mi się bezwartościowe", "Łatwo wpadałem w irytację", "Pociłem się (bez upału/wysiłku)", "Bałem się bez konkretnego powodu", "Czułem, że życie jest bez sensu", "Trudno było mi się uspokoić po zdenerwowaniu"
        ];
        genForm('f-dass42', d42Q, 4, 'd42');

        // DASSY
        const dyQ = [
            "Denerwowałem/am się z powodu drobnych rzeczy", "Czułem/am zawroty głowy, jakbym miał/a zemdleć", "Nic mnie nie cieszyło", "Miałem/am trudności z oddychaniem (np. szybki oddech), mimo że nie ćwiczyłem/am i nie byłem/am chory", "Nienawidziłem/am swojego życia", "Reagowałem/am zbyt mocno na sytuacje", "Czułem drżenie rąk", "Martwiłem/am się o wiele rzeczy", "Byłem/am przerażony/a", "Nie było nic, na co mógłbym/mogłabym czekać z radością", "Szybko czułem irytację", "Trudno było mi się zrelaksować.", "Nie mogłem/am przestać czuć się smutny/a", "Denerwowało mnie, gdy ludzie mi przerywali.", "Miałem/am wrażenie, że zaraz spanikuję", "Nienawidziłem/am siebie", "Czułem/am, że jestem do niczego.", "Łatwo się irytowałem", "Czułem/am bardzo szybkie bicie serca, mimo że nie wykonywałem/am intensywnego wysiłku", "Czułem/am strach bez powodu", "Czułem/am, że życie jest okropne"
        ];
        genForm('f-dassy', dyQ, 4, 'dy');
        
        // PHQ-9
        const pQ = ["Małe zainteresowanie/radość", "Przygnębienie/beznadzieja", "Problemy ze snem", "Zmęczenie/brak energii", "Apetyt (brak/nadmiar)", "Poczucie porażki", "Problemy z koncentracją", "Spowolnienie/pobudzenie", "Myśli o samookaleczeniu"];
        genForm('f-phq9', pQ, 4, 'p', ["Wcale", "Kilka dni", "Połowa dni", "Codziennie"]);

        // GAD-7
        const gQ = ["Zdenerwowanie/lęk", "Brak kontroli nad martwieniem", "Martwienie się na zapas", "Trudno się odprężyć", "Niepokój ruchowy", "Irytacja", "Strach przed najgorszym"];
        genForm('f-gad7', gQ, 4, 'g', ["Wcale", "Kilka dni", "Połowa dni", "Codziennie"]);

        // BDI-II
        const bQ = [
            {q: "Smutek", o: ["Nie jestem w ogóle smutny ani przygnębiony.", "Czuję się smutny przez większość czasu.", "Jestem stale smutny i przygnębiony.", "Jestem tak nieszczęśliwy i smutny, że jest to nie do wytrzymania."]},
            {q: "Pesymizm", o: ["Nie obawiam się o swoją przyszłość.", "Obawiam się o przyszłość bardziej niż dotychczas.", "Nie oczekuję, że przyszłość będzie się dla mnie układać pomyślnie.", "Uważam, że moja przyszłość jest beznadziejna i że będzie coraz gorsza."]},
            {q: "Przeszłe niepowodzenia", o: ["Nie czuję, że odnosiłem wiele porażek.", "Zawodziłem więcej razy niż powinienem", "Patrząc wstecz, widzę dużo niepowodzeń.", "Uważam, że jako człowiek jestem totalnym nieudacznikiem."]},
            {q: "Odczuwanie przyjemności", o: ["Robienie rzeczy, które lubię dostarcza mi tyle samo przyjemności co w przeszłości.", "To co robię nie sprawia mi takiej samej przyjemności jak kiedyś.", "Odczuwam bardzo niewiele przyjemności z rzeczy, które kiedyś lubiłem.", "Nie odczuwam żadnej przyjemności z rzeczy, które kiedyś lubiłem."]},
            {q: "Poczucie winy", o: ["Nie czuje się szczególnie winien.", "Czuję się winny z powodu wielu rzeczy, które zrobiłem lub których nie zrobiłem.", "Czuję się winny przez większość czasu.", "Czuje się winny bez przerwy."]},
            {q: "Poczucie kary", o: ["Nie czuję żebym był karany.", "Czuję, że mogę zostać ukarany.", "Oczekuję kary.", "Czuję, że jestem karany."]},
            {q: "Stosunek do samego siebie", o: ["Mam o sobie takie samo zdanie jak przedtem.", "Straciłem wiarę w siebie.", "Zawiodłem się na sobie.", "Czuję do siebie niechęć."]},
            {q: "Samokrytycyzm", o: ["Nie krytykuję siebie anie nie obwiniam więcej niż kiedyś.", "Jestem bardziej krytycznie nastawiony do siebie niż kiedyś.", "Krytykuję siebie za wszystkie swoje niepowodzenia.", "Obwiniam się za każde zło, które się wydarza."]},
            {q: "Myśli samobójcze", o: ["Nie myślę o zabiciu się.", "Myślę o tym, by się zabić, ale wiem, że bym tego nie zrobił.", "Pragnę się zabić.", "Zabije się jeśli tylko natrafi się odpowiednia do tego sposobność."]},
            {q: "Płacz", o: ["Nie płaczę częściej niż zazwyczaj.", "Płaczę częściej niż zazwyczaj.", "Płaczę ciągle, nawet z powodu drobnostek.", "Chciałbym płakać, ale nie jestem w stanie."]},
            {q: "Pobudzenie", o: ["Nie czuje się bardziej niespokojny czy pobudzony niż dawniej.", "Czuje się bardziej niespokojny czy pobudzony niż dawniej.", "Jestem tak pobudzony i niespokojny, że trudno mi się uspokoić.", "Jestem tak pobudzony i nisepokojny, że muszę wciąż coś robić lub poruszać się."]},
            {q: "Utrata zainteresowań", o: ["Ludzie i czynności codzienne interesują mnie tak jak dawniej.", "Coraz mniej interesują mnie otaczający mnie ludzie oraz czynności codzienne.", "Utraciłem większość zainteresowania ludźmi albo czynnościami codziennymi.", "Trudno mi się czymkolwiek zainteresować."]},
            {q: "Niezdecydowanie", o: ["Podejmuję decyzje tak łatwo jak kiedyś.", "Trudniej jest mi podejmować decyzje niż kiedyś.", "Mam dużą trudność w podejmowaniu decyzji.", "Nie jestem w stanie podejmować jakichkolwiek decyzji."]},
            {q: "Bezużyteczność", o: ["Nie czuję się bezwartościowy.", "Nie uważam, że jestem równie przydatny i warty uwagi jak kiedyś.", "Czuje się bardziej bezwartościowy w porównaniu do innych.", "Czuję się całkowicie bezwartościowy."]},
            {q: "Utrata energii", o: ["Mam tyle samo energii co dawniej.", "Mam mniej energii niż dawniej.", "Nie mam wystarczającej ilości energii aby wykonywać większość czynności.", "Nie mam energii aby robić cokolwiek."]},
            {q: "Zmiany we wzorcu snu", o: ["Sypiam tak dobrze jak dotychczas.", "Śpię nieco więcej/mniej niż dotychczas.", "Śpię znacznie więcej/mniej niż dotychczas.", "Budzę się 1-2 godziny za wcześnie i nie mogę ponownie usnąć/ śpię przez większość dnia."]},
            {q: "Drażliwość", o: ["Nie jestem bardziej drażliwy niż zazwyczaj.", "Jestem bardziej drażliwy niż zazwyczaj.", "Jestem o wiele bardziej drażliwy niż zazwyczaj.", "Jestem drażliwy przez cały czas."]},
            {q: "Zmiany apetycie", o: ["Mam taki sam apetyt jak zwykle.", "Mam trochę mniejszy/większy apetyt niż dotychczas.", "Mam znacznie mniejszy/większy apetyt niż dotychczas.", "Nie mam w ogóle apetytu / jestem głodny cały czas."]},
            {q: "Problemy z koncentracją", o: ["Umiem się koncentrować tak dobrze jak wcześniej.", "Nie umiem koncentrować się tak dobrze jak wcześniej.", "Trudno mi skupić się na czymś przez dłuższy czas.", "Nie mogę skoncentrować się na niczym."]},
            {q: "Zmęczenie", o: ["Nie czuję się bardziej zmęczony niż dotychczas.", "Męczę się szybciej niż zazwyczaj.", "Jestem tak zmęczony, że nie mogę wykonywać wielu zadań, które dotychczas wykonywałem.", "Jestem zbyt zmęczony  żeby wykonywać większość czynności, które dotychczas wykonywałem."]},
            {q: "Utrata zainteresowania seksem", o: ["Moje zainteresowanie seksem nie uległo zmianie.", "Jestem mniej zainteresowany seksem niż dotychczas.", "Jestem obecnie dużo mniej zainteresowany seksem niż dotychczas.", "Straciłem całkowite zainteresowanie seksem."]}
        ];
        genFormBDI('f-bdi', bQ, 'b');

        // LSAS (Leibowitz)
        const lQ = [
            "Rozmawianie przez telefon przy innych osobach", "Udział w małej grupie (parę osób)", "Jedzenie w miejscach publicznych", "Picie z innymi w miejscach publicznych", "Rozmowa z osobą na wyższym stanowisku", "Występowanie/przemawianie przed publicznością", "Pójście na imprezę", "Praca, gdy ktoś inny patrzy", "Pisanie, gdy ktoś inny patrzy", "Dzwonienie do kogoś, kogo słabo znasz", "Rozmowa z kimś, kogo słabo znasz", "Spotkanie z nieznajomymi", "Korzystanie z publicznej toalety", "Wejście do pokoju, w którym siedzą już inni", "Bycie w centrum zainteresowania", "Zabranie głosu na spotkaniu", "Przystąpienie do testu wiedzy/umiejętności", "Wyrażenie niezgody osobie mało znanej", "Patrzenie w oczy osobie mało znanej", "Przygotowany referat wygłaszany przed grupą", "Próba nawiązania bliższej relacji (podrywanie)", "Zwracanie towaru do sklepu", "Wydanie przyjęcia/imprezy", "Opieranie się presji sprzedawcy"
        ];
        genFormLSAS('f-lsas', lQ, 'l');
        
        // CISS
        const cissQuestions = [
            "Lepiej planuję swój czas", "Koncentruję się na problemie i zastanawiam się, jak mogę go rozwiązać", "Myślę o czasach gdy było mi lepiej", "Staram się przebywać z innymi ludźmi", "Oskarżam się o zwlekanie", "Robię to co uważam za najlepsze", "Jestem skupiony(a) na swoich dolegliwościach fizycznych", "Winię siebie, że wpadłem(am) w taką sytuację", "Włóczę się po sklepach lub przeglądam oferty", "Ustalam, co w danej sytuacji jest najważniejsze", "Staram się zasnąć", "Objadam się ulubioną potrawą", "Niepokoję się, że sobie nie poradzę", "Staję się bardzo napięty(a)", "Myślę o tym, jak rozwiązywałem(am) podobne problemy w przeszłości", "Wmawiam sobie, że to w rzeczywistości nie dzieje się mnie", "Winię siebie, że zbyt się tym przejmuję", "Idę coś zjeść na mieście", "Staje się bardzo przygnębiony(a)", "Kupuję sobie coś", "Wyznaczam sobie kierunek działania i postępuję zgodnie z nim",
            "Obwiniam siebie za to, że nie wiem co zrobić", "Idę się zabawić", "Staram się zrozumieć sytuację", "Zastygam w bezruchu i nie wiem co zrobić", "Podejmuję natychmiast właściwe działanie", "Analizuję sytuację i uczę się na własnych błędach", "Żałuję, że nie mogę zmienić tego co się stało, lub tego, co odczuwałem(am) w związku z tym", "Odwiedzam przyjaciela", "Martwię się, jak sobie z tym poradzę", "Spędzam czas z bliską osobą", "Wychodzę na spacer", "Wmawiam sobie, że to się nigdy więcej nie powtórzy", "Skupiam się na swoich ogólnych brakach", "Rozmawiam z kimś, kogo rady sobie cenię", "Analizuję problem zanim zacznę działać", "Dzwonię do kolegi lub koleżanki", "Wpadam w złość", "Zmieniam kolejność spraw do załatwienia", "Oglądam film", "Dążę do kontrolowania sytuacji", "Podejmuję dodatkowy wysiłek, aby załatwić sprawę", "Podchodzę do problemu z różnych stron", "Robię sobie wolnę, by uciec od problemu", "Wyładowuję się na innych", "Wykorzystuję sytuację, aby udowodnić, że potrafię tego dokonać", "Staram się tak zorganizować sprawy, aby zapanować nad sytuacją", "Oglądam telewizję"      
        ];
        genForm('f-ciss', cissQuestions, 5, 'ci', ["1", "2", "3", "4", "5"]);
    }

    function genForm(id, qs, n, prefix, labels=null) {
        const f = document.getElementById(id);
        f.innerHTML = qs.map((q, i) => `
            <div class="question-row">
                <span class="q-text">${i+1}. ${q}</span>
                <div class="options-group">
                    ${Array(n).fill(0).map((_, v) => `
                        <label class="opt-label">
                            <input type="radio" name="${prefix}${i}" value="${v}" required>
                            <span>${labels ? labels[v] : v}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    function genFormBDI(id, questions, prefix) {
        const f = document.getElementById(id);
        f.innerHTML = questions.map((item, i) => `
            <div class="question-row">
                <span class="q-text">${i+1}. ${item.q}</span>
                <div class="options-group">
                    ${item.o.map((opt, v) => `
                        <label class="opt-label">
                            <input type="radio" name="${prefix}${i}" value="${v}" required>
                            <span>${opt}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    // Generator LSAS (Podwójna punktacja)
    function genFormLSAS(id, qs, prefix) {
        const f = document.getElementById(id);
        f.innerHTML = qs.map((q, i) => `
            <div class="question-row">
                <span class="q-text">${i+1}. ${q}</span>
                <div class="lsas-label-mini">Lęk / Strach:</div>
                <div class="options-group">
                    ${["Brak", "Łagodny", "Umiark.", "Silny"].map((lbl, v) => `
                        <label class="opt-label">
                            <input type="radio" name="${prefix}f${i}" value="${v}" required>
                            <span>${lbl}</span>
                        </label>
                    `).join('')}
                </div>
                <div class="lsas-label-mini">Unikanie:</div>
                <div class="options-group">
                    ${["Nigdy", "Rzadko", "Często", "Zawsze"].map((lbl, v) => `
                        <label class="opt-label">
                            <input type="radio" name="${prefix}a${i}" value="${v}" required>
                            <span>${lbl}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    /* --- FEATURE 4: AUTO SAVE & LOAD --- */
    function initAutoSave() {
        // Nasłuchuj zmian na wszystkich inputach i textarea
        document.getElementById('dashboard').addEventListener('input', () => {
            saveData();
        });
        document.getElementById('dashboard').addEventListener('change', () => {
            saveData();
        });
    }

    function saveData() {
        const data = {};
        // Zapisz dane demograficzne
        data['p-init'] = document.getElementById('p-init').value;
        data['p-gender'] = document.getElementById('p-gender').value;
        data['p-age-group'] = document.getElementById('p-age-group').value;
        data['p-date'] = document.getElementById('p-date').value;

        // Zapisz radia
        document.querySelectorAll('input[type="radio"]:checked').forEach(r => {
            data[r.name] = r.value;
        });

        // Zapisz textareas (Kontrakt i Notatki)
        document.querySelectorAll('textarea, input[type="text"]').forEach(t => {
            if(t.id) data[t.id] = t.value;
        });

        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadProgress() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return;
        try {
            const data = JSON.parse(raw);
            
            // Przywróć dane demograficzne
            if(data['p-init']) document.getElementById('p-init').value = data['p-init'];
            if(data['p-gender']) document.getElementById('p-gender').value = data['p-gender'];
            if(data['p-age-group']) document.getElementById('p-age-group').value = data['p-age-group'];
            if(data['p-date']) document.getElementById('p-date').value = data['p-date'];

            // Przywróć inputy tekstowe i textareas
            for (const [key, val] of Object.entries(data)) {
                const el = document.getElementById(key);
                if(el && (el.tagName === 'TEXTAREA' || el.type === 'text')) {
                    el.value = val;
                }
            }

            // Przywróć radia
            for (const [key, val] of Object.entries(data)) {
                const radios = document.getElementsByName(key);
                if(radios.length) {
                    radios.forEach(r => {
                        if(r.value === val) r.checked = true;
                    });
                }
            }
        } catch(e) {
            console.error("Błąd odczytu zapisu", e);
        }
    }

    function clearData() {
        if(confirm("Czy na pewno chcesz wyczyścić wszystkie dane i odpowiedzi?")) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }

    function calculateCurrent() {
        const activeSection = document.querySelector('.test-section.active');
        const activeId = activeSection.id;

        if(activeId === 't-contract') {
            const shouldPrint = confirm("Kontrakt na życie nie wymaga obliczeń. Czy chcesz go wydrukować?");
            if(shouldPrint) window.print();
            return;
        }

        const inputs = activeSection.querySelectorAll('input[type="radio"]');
        const names = [...new Set([...inputs].map(i => i.name))];
        const checked = activeSection.querySelectorAll('input:checked');
        if(checked.length < names.length) {
            alert("Proszę odpowiedzieć na wszystkie pytania w tej sekcji!");
            return;
        }

        if(activeId === 't-dass') calcDASS();
        else if(activeId === 't-dass42') calcD42();
        else if(activeId === 't-dassy') calcDassy();
        else if(activeId === 't-phq9') calcPHQ();
        else if(activeId === 't-gad7') calcGAD();
        else if(activeId === 't-bdi') calcBDI();
        else if(activeId === 't-lsas') calcLSAS();
        else if(activeId === 't-ciss') calcCISS();
    }

    function calcDASS() {
        const getSum = (idx) => {
            let s = 0;
            idx.forEach(i => {
                const r = document.querySelector(`input[name="d${i}"]:checked`);
                if(r) s += parseInt(r.value);
            });
            return s * 2;
        };
        const d = getSum([2,4,9,12,15,16,20]);
        const a = getSum([1,3,6,8,14,18,19]);
        const s = getSum([0,5,7,10,11,13,17]);
        const interp = (v, th) => v<=th[0]?"Norma":v<=th[1]?"Łagodny":v<=th[2]?"Umiarkowany":v<=th[3]?"Silny":"B. Silny";
        
        document.getElementById('res-dass').innerHTML = `
            <h3>Wyniki DASS-21:</h3>
            <div class="res-line">Depresja: <span>${d} - ${interp(d, [9,13,20,27])}</span></div>
            <div class="res-line">Lęk: <span>${a} - ${interp(a, [7,9,14,19])}</span></div>
            <div class="res-line">Stres: <span>${s} - ${interp(s, [14,18,25,33])}</span></div>
        `;
        document.getElementById('res-dass').style.display = 'block';
    }

    function calcD42() {
        const getSum = (idx) => {
            let s = 0;
            idx.forEach(i => { const r = document.querySelector(`input[name="d42${i}"]:checked`); if(r) s += parseInt(r.value); });
            return s;
        };
        const d = getSum([2,4,9,12,15,16,20,23,25,30,33,35,36,40]);
        const a = getSum([1,3,6,8,14,18,19,22,24,27,29,34,38,39]);
        const s = getSum([0,5,7,10,11,13,17,21,26,28,31,32,37,41]);
        renderDassRes('res-dass42', d, a, s, true);
    }

    function calcDassy() {
        const getSum = (idx) => {
            let s = 0;
            idx.forEach(i => { const r = document.querySelector(`input[name="dy${i}"]:checked`); if(r) s += parseInt(r.value); });
            return s;
        };
        const d = getSum([2,4,9,12,15,16,20]), a = getSum([1,3,6,8,14,18,19]), s = getSum([0,5,7,10,11,13,17]);
        renderDassRes('res-dassy', d, a, s, false, true);
    }

    function renderDassRes(id, d, a, s, isFull=false, isDassy=false) {
        const interp = (v, th) => v<=th[0]?"Norma":v<=th[1]?"Łagodny":v<=th[2]?"Umiarkowany":v<=th[3]?"Silny":"B. Silny";
        const thD = [6,8,13,16]; 
        const thA = [5,7,12,15];
        const thS = [11,13,16,18];
        document.getElementById(id).innerHTML = `
            <h3>Wyniki ${isDassy?'DASSY':(isFull?'DASS-42':'DASS-21')}:</h3>
            <div class="res-line">Depresja: <span>${d} - ${interp(d, thD)}</span></div>
            <div class="res-line">Lęk: <span>${a} - ${interp(a, thA)}</span></div>
            <div class="res-line">Stres: <span>${s} - ${interp(s, thS)}</span></div>
        `;
        document.getElementById(id).style.display = 'block';
    }

    function calcPHQ() {
        let sum = 0;
        document.querySelectorAll('#f-phq9 input:checked').forEach(i => sum += parseInt(i.value));
        const txt = sum<=4?"Norma":sum<=9?"Łagodna":sum<=14?"Umiarkowana":sum<=19?"Umiarkowanie ciężka":"Ciężka";
        
        let warning = "";
        // Feature 3: Check item 9 (index 8) for suicide risk
        const riskItem = document.querySelector('input[name="p8"]:checked');
        if(riskItem && parseInt(riskItem.value) > 0) {
            warning = `<div class="alert-box">⚠️ UWAGA: Pacjent zgłosił myśli samobójcze (Pyt. 9).</div>`;
        }

        document.getElementById('res-phq9').innerHTML = `<h3>Suma PHQ-9: ${sum}</h3><p>Interpretacja: ${txt}</p>${warning}`;
        document.getElementById('res-phq9').style.display = 'block';
    }

    function calcGAD() {
        let sum = 0;
        document.querySelectorAll('#f-gad7 input:checked').forEach(i => sum += parseInt(i.value));
        const txt = sum<=4?"Norma":sum<=9?"Łagodny":sum<=14?"Umiarkowany":"Silny";
        document.getElementById('res-gad7').innerHTML = `<h3>Suma GAD-7: ${sum}</h3><p>Interpretacja: ${txt}</p>`;
        document.getElementById('res-gad7').style.display = 'block';
    }

    function calcBDI() {
        let sum = 0;
        document.querySelectorAll('#f-bdi input:checked').forEach(i => sum += parseInt(i.value));
        let interpretation = sum <= 13 ? "Minimalna" : sum <= 19 ? "Łagodna" : sum <= 28 ? "Umiarkowana" : "Ciężka";
        
        let warning = "";
        // Feature 3: Check item 9 (index 8) for suicide risk in BDI
        const riskItem = document.querySelector('input[name="b8"]:checked');
        if(riskItem && parseInt(riskItem.value) > 0) {
            warning = `<div class="alert-box">⚠️ UWAGA: Pacjent zgłosił myśli samobójcze (Pyt. 9).</div>`;
        }

        document.getElementById('res-bdi').innerHTML = `<h3>Suma BDI-II: ${sum} pkt</h3><p>Interpretacja: ${interpretation} depresja.</p>${warning}`;
        document.getElementById('res-bdi').style.display = 'block';
    }

    function calcLSAS() {
        let fSum = 0, aSum = 0;
        document.querySelectorAll('#f-lsas input[name^="lf"]:checked').forEach(i => fSum += parseInt(i.value));
        document.querySelectorAll('#f-lsas input[name^="la"]:checked').forEach(i => aSum += parseInt(i.value));
        const total = fSum + aSum;
        const interp = total <= 54 ? "Brak fobii" : total <= 65 ? "Łagodna" : total <= 80 ? "Umiarkowana" : total <= 95 ? "Nasilona" : "Bardzo silna";
        document.getElementById('res-lsas').innerHTML = `
            <h3>LSAS: ${total} pkt</h3>
            <div class="res-line">Lęk (suma): <span>${fSum}</span></div>
            <div class="res-line">Unikanie (suma): <span>${aSum}</span></div>
            <div class="res-line">Interpretacja: <span>${interp}</span></div>
        `;
        document.getElementById('res-lsas').style.display = 'block';
    }

    function calcCISS() {
        const ageGroup = document.getElementById('p-age-group').value;
        const key = {
            ssz: [0, 1, 5, 9, 14, 20, 23, 25, 26, 35, 38, 40, 41, 42, 44, 46],
            sse: [4, 6, 7, 12, 13, 15, 16, 18, 21, 24, 27, 29, 32, 33, 37, 44],
            ssu: [2, 3, 8, 10, 11, 17, 19, 22, 28, 30, 31, 34, 36, 39, 43, 47]
        };
    
        const getScore = (indices) => {
            let sum = 0;
            indices.forEach(idx => {
                const r = document.querySelector(`input[name="ci${idx}"]:checked`);
                if(r) sum += (parseInt(r.value) + 1);
            });
            return sum;
        };
    
        const raw = { ssz: getScore(key.ssz), sse: getScore(key.sse), ssu: getScore(key.ssu) };
        
        // Normy uproszczone/przykładowe
        const norms = {
            '16-24': {
                ssz: [30, 39, 47, 52, 57, 61, 65, 68, 73],
                sse: [21, 26, 32, 37, 42, 50, 55, 61, 69],
                ssu: [30, 34, 39, 44, 50, 54, 59, 64, 68]
            },
            '25-54': {
                ssz: [38, 43, 48, 52, 57, 61, 65, 68, 74], 
                sse: [24, 30, 35, 39, 43, 51, 55, 60, 64],
                ssu: [27, 30, 34, 38, 43, 47, 52, 56, 61]
            },
            '55-79': {
                ssz: [37, 42, 46, 50, 55, 60, 64, 68, 72],
                sse: [26, 31, 36, 41, 45, 50, 56, 62, 69],
                ssu: [25, 31, 35, 38, 44, 49, 53, 57, 61]
            }
        };

        const calculateSten = (score, scaleNorms) => {
            for (let i = 0; i < scaleNorms.length; i++) {
                if (score <= scaleNorms[i]) return i + 1;
            }
            return 10;
        };

        const stens = {
            ssz: calculateSten(raw.ssz, norms[ageGroup].ssz),
            sse: calculateSten(raw.sse, norms[ageGroup].sse),
            ssu: calculateSten(raw.ssu, norms[ageGroup].ssu)
        };

        const getInterp = (s) => s <= 3 ? "Niski" : s <= 7 ? "Przeciętny" : "Wysoki";

        document.getElementById('res-ciss').innerHTML = `
            <h3>Wyniki CISS (Grupa wiekowa: ${ageGroup}):</h3>
            <table style="width:100%; border-collapse: collapse; margin-top:10px;">
                <tr><th>Skala</th><th>Surowy</th><th>Sten</th><th>Interpretacja</th></tr>
                <tr><td>Zadanie (SSZ)</td><td>${raw.ssz}</td><td>${stens.ssz}</td><td>${getInterp(stens.ssz)}</td></tr>
                <tr><td>Emocje (SSE)</td><td>${raw.sse}</td><td>${stens.sse}</td><td>${getInterp(stens.sse)}</td></tr>
                <tr><td>Unikanie (SSU)</td><td>${raw.ssu}</td><td>${stens.ssu}</td><td>${getInterp(stens.ssu)}</td></tr>
            </table>
        `;
        document.getElementById('res-ciss').style.display = 'block';
    }

    /* --- FEATURE 1: PDF EXPORT --- */
    function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Helper to map PL chars to ASCII for PDF basic font support
        const plMap = {'ą':'a', 'ć':'c', 'ę':'e', 'ł':'l', 'ń':'n', 'ó':'o', 'ś':'s', 'ź':'z', 'ż':'z', 'Ą':'A', 'Ć':'C', 'Ę':'E', 'Ł':'L', 'Ń':'N', 'Ó':'O', 'Ś':'S', 'Ź':'Z', 'Ż':'Z'};
        const toAscii = (str) => str.split('').map(c => plMap[c] || c).join('');

        const activeSec = document.querySelector('.test-section.active');
        if(!activeSec) return;
        const testName = activeSec.querySelector('h2').innerText;
        const resultDiv = activeSec.querySelector('.result-panel');
        const notes = activeSec.querySelector('textarea[id^="note-"]').value;

        // Header
        doc.setFontSize(16);
        doc.text("Raport Diagnostyczny", 10, 10);
        
        doc.setFontSize(12);
        doc.text("Pacjent: " + toAscii(document.getElementById('p-init').value), 10, 20);
        doc.text("Data: " + document.getElementById('p-date').value, 10, 26);
        doc.text("Test: " + toAscii(testName), 10, 32);

        // Results
        if(resultDiv && resultDiv.style.display !== 'none') {
            doc.text("WYNIKI:", 10, 45);
            let y = 52;
            const lines = resultDiv.innerText.split('\n');
            lines.forEach(l => {
                if(l.trim()) {
                    doc.text(toAscii(l.trim()), 10, y);
                    y += 6;
                }
            });
            
            // Notes
            if(notes) {
                y += 10;
                doc.text("NOTATKI KLINICZNE:", 10, y);
                const splitNotes = doc.splitTextToSize(toAscii(notes), 180);
                doc.text(splitNotes, 10, y + 6);
            }
        } else if (activeSec.id === 't-contract') {
             doc.text("KONTRAKT NA ZYCIE - WYDRUK UPROSZCZONY", 10, 45);
             doc.text("Zaleca sie uzycie systemowej opcji DRUKUJ dla kontraktu.", 10, 55);
        } else {
            doc.text("Brak obliczonych wynikow. Kliknij 'Oblicz wynik'.", 10, 45);
        }

        doc.save(`Raport_${toAscii(testName)}.pdf`);
    }

    /* --- FEATURE 9: CSV EXPORT --- */
    function exportCSV() {
        let csv = "Sekcja,Pytanie/Pole,Odpowiedz\n";
        
        // Dane pacjenta
        csv += `Pacjent,Inicjaly,${document.getElementById('p-init').value}\n`;
        csv += `Pacjent,Data,${document.getElementById('p-date').value}\n`;

        // Iteracja przez aktywne inputy
        document.querySelectorAll('.test-section').forEach(sec => {
            const secName = sec.querySelector('h2').innerText;
            
            // Radio buttons
            sec.querySelectorAll('.question-row').forEach(row => {
                const qText = row.querySelector('.q-text') ? row.querySelector('.q-text').innerText.replace(/,/g, ' ') : "Pytanie";
                const checked = row.querySelector('input:checked');
                if(checked) {
                    csv += `${secName},"${qText}",${checked.value}\n`;
                }
            });

            // Text areas
            sec.querySelectorAll('textarea').forEach(txt => {
                if(txt.value) {
                    const label = txt.previousElementSibling ? txt.previousElementSibling.innerText : "Pole tekstowe";
                    csv += `${secName},"${label.replace(/,/g, ' ')}","${txt.value.replace(/\n/g, ' ').replace(/"/g, '""')}"\n`;
                }
            });
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `Wyniki_${document.getElementById('p-init').value || 'Pacjent'}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        }
       function initSignaturePads() {
    const canvases = document.querySelectorAll('.sig-canvas');
    canvases.forEach(canvas => {
        const ctx = canvas.getContext('2d');
        let drawing = false;

        const getPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) * (canvas.width / rect.width),
                y: (clientY - rect.top) * (canvas.height / rect.height)
            };
        };

        const draw = (e) => {
            if (!drawing) return;
            const pos = getPos(e);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            e.preventDefault();
        };

        canvas.addEventListener('mousedown', (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); });
        canvas.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', () => { if(drawing) { drawing = false; saveSignatures(); } });

        canvas.addEventListener('touchstart', (e) => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); }, {passive: false});
        canvas.addEventListener('touchmove', draw, {passive: false});
        canvas.addEventListener('touchend', () => { drawing = false; saveSignatures(); });

        ctx.lineWidth = 2; ctx.lineCap = "round"; ctx.strokeStyle = "#000";
    });
}

function clearCanvas(id) {
    const canvas = document.getElementById(id);
    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
    saveSignatures();
}

// Zapisywanie podpisów jako obrazy Base64 w localStorage
function saveSignatures() {
    const sigs = {};
    document.querySelectorAll('.sig-canvas').forEach(canvas => {
        sigs[canvas.id] = canvas.toDataURL();
    });
    localStorage.setItem('saved_signatures', JSON.stringify(sigs));
}

// Odczytywanie podpisów po odświeżeniu
function loadSignatures() {
    const saved = localStorage.getItem('saved_signatures');
    if (!saved) return;
    const sigs = JSON.parse(saved);
    for (let id in sigs) {
        const canvas = document.getElementById(id);
        if (canvas) {
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => ctx.drawImage(img, 0, 0);
            img.src = sigs[id];
        }
    }
}

</script>

</body>
</html>
