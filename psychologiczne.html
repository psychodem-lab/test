<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Psychologa - Diagnostyka i Interpretacja</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #475569;
            --bg-color: #f1f5f9;
            --surface-color: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --success-bg: #dcfce7;
            --success-text: #166534;
            --warning-bg: #fef9c3;
            --warning-text: #854d0e;
            --danger-bg: #fee2e2;
            --danger-text: #991b1b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- Login --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-color);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .login-box {
            background: var(--surface-color); padding: 2.5rem; border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px; text-align: center;
        }
        .login-box input {
            width: 100%; padding: 0.75rem; margin: 1rem 0; border: 1px solid var(--border-color);
            border-radius: 6px; font-size: 1rem;
        }

        /* --- Layout --- */
        #dashboard {
            display: none;
            max-width: 1100px;
            margin: 0 auto;
            width: 100%;
            padding: 2rem;
            flex: 1;
        }

        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color);
        }
        
        .header-inputs { display: flex; gap: 1rem; }
        .header-inputs input {
            padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;
        }

        /* --- Tabs --- */
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .tab-btn {
            background: var(--surface-color); border: 1px solid var(--border-color);
            padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer;
            font-weight: 500; color: var(--secondary-color); transition: all 0.2s;
        }
        .tab-btn:hover { background: #e2e8f0; }
        .tab-btn.active {
            background: var(--primary-color); color: white; border-color: var(--primary-color);
        }

        /* --- Test Content --- */
        .test-content {
            display: none; background: var(--surface-color); padding: 2.5rem;
            border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .test-content.active { display: block; }

        .test-header h2 { margin-bottom: 0.5rem; color: var(--text-main); }
        .test-header .desc { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 2rem; }
        .source-cite { font-size: 0.75rem; color: #94a3b8; margin-top: 5px; font-style: italic; }

        /* --- Scales --- */
        .scale-item {
            margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #f1f5f9;
            page-break-inside: avoid; /* Zapobiega cięciu pytań w PDF */
        }
        .scale-question { font-weight: 500; margin-bottom: 0.75rem; display: block; }
        
        .options-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(50px, 1fr)); gap: 10px;
        }
        .radio-label {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px;
            font-size: 0.85rem; text-align: center; transition: background 0.2s;
        }
        .radio-label:hover { background-color: #f8fafc; border-color: var(--primary-color); }
        .radio-label input { margin-bottom: 0.4rem; }
        
        /* Styl zaznaczonego elementu dla jasności wizualnej */
        .radio-label input:checked + span { font-weight: bold; color: var(--primary-color); }

        /* --- Result Box --- */
        .result-box {
            margin-top: 2rem; padding: 1.5rem; border-radius: 8px;
            background-color: #f8fafc; border: 1px solid var(--border-color);
            display: none;
            page-break-inside: avoid;
        }
        .result-box h3 { margin-bottom: 1rem; border-bottom: 1px solid #cbd5e1; padding-bottom: 0.5rem; }
        .result-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 1rem; }
        .score-val { font-weight: 700; }
        .interpretation { font-weight: 600; }

        /* Kolory interpretacji */
        .severity-low { color: var(--success-text); }
        .severity-med { color: var(--warning-text); }
        .severity-high { color: var(--danger-text); }

        /* --- Buttons --- */
        .btn {
            background-color: var(--primary-color); color: white; border: none;
            padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 500; cursor: pointer;
        }
        .btn:hover { background-color: #1d4ed8; }
        .btn-action-group { margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem; }
        .btn-calc { background-color: #4f46e5; }
        .btn-print { background-color: #059669; }

        /* --- PDF Specyficzne --- */
        /* Klasa dodawana dynamicznie podczas generowania PDF */
        .pdf-mode .pdf-header { display: block !important; }
        .pdf-mode {
            background-color: #ffffff !important;
            padding: 20px !important;
            margin: 0 !important;
            border: none !important;
            box-shadow: none !important;
        }
        .pdf-header { display: none; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 10px; }
        
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2>Panel Psychologa</h2>
            <p style="color:var(--text-muted); margin-bottom: 1rem;">Dostęp do narzędzi psychometrycznych</p>
            <input type="password" id="password-input" placeholder="Hasło (domyślne: psycholog2026)">
            <button class="btn" onclick="checkPassword()">Zaloguj się</button>
            <p id="login-error" style="color:red; display:none; margin-top:1rem;">Błędne hasło.</p>
        </div>
    </div>

    <div id="dashboard">
        <header>
            <div>
                <h1>Narzędzia Diagnostyczne</h1>
                <p style="color:var(--text-muted)">Panel zapisu i interpretacji</p>
            </div>
            <div class="header-inputs">
                <input type="text" id="patient-initials" placeholder="Inicjały Pacjenta">
                <input type="date" id="exam-date">
            </div>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" onclick="switchTab('dass')">DASS-21</button>
            <button class="tab-btn" onclick="switchTab('phq9')">PHQ-9 (Depresja)</button>
            <button class="tab-btn" onclick="switchTab('gad7')">GAD-7 (Lęk)</button>
            <button class="tab-btn" onclick="switchTab('bdi')">BDI (Szablon)</button>
            <button class="tab-btn" onclick="switchTab('ybocs')">Y-BOCS (Szablon)</button>
        </nav>

        <div id="dass" class="test-content active">
            <div class="pdf-container">
                <div class="pdf-header">
                    <h2>Wyniki Badania: DASS-21</h2>
                    <p>Pacjent: <span class="p-initials"></span> | Data: <span class="p-date"></span></p>
                </div>
                <div class="test-header">
                    <h2>Skala Depresji, Lęku i Stresu (DASS-21)</h2>
                    <p class="desc">Proszę zaznaczyć liczbę (0-3), która najlepiej opisuje samopoczucie w ciągu ostatniego tygodnia.</p>
                    <p class="source-cite">Źródło: Lovibond, S.H. & Lovibond, P.F. (1995). Manual for the Depression Anxiety Stress Scales.</p>
                </div>
                <form id="form-dass"><div id="dass-questions"></div></form>
                
                <div id="dass-result" class="result-box">
                    <h3>Interpretacja Wyników (x2)</h3>
                    <div class="result-row"><span>Depresja:</span> <span id="dass-dep-score"></span></div>
                    <div class="result-row"><span>Lęk:</span> <span id="dass-anx-score"></span></div>
                    <div class="result-row"><span>Stres:</span> <span id="dass-str-score"></span></div>
                    <p style="font-size:0.8rem; margin-top:10px; color:#64748b;">*Wyniki DASS-21 zostały pomnożone przez 2 zgodnie z kluczem, aby odnosiły się do norm pełnej skali DASS-42.</p>
                </div>
            </div>
            <div class="btn-action-group">
                <button class="btn btn-calc" onclick="calculateDASS()">Oblicz Wynik</button>
                <button class="btn btn-print" onclick="generatePDF('dass')">Zapisz PDF</button>
            </div>
        </div>

        <div id="phq9" class="test-content">
            <div class="pdf-container">
                <div class="pdf-header">
                    <h2>Wyniki Badania: PHQ-9</h2>
                    <p>Pacjent: <span class="p-initials"></span> | Data: <span class="p-date"></span></p>
                </div>
                <div class="test-header">
                    <h2>Kwestionariusz Zdrowia Pacjenta-9 (PHQ-9)</h2>
                    <p class="desc">Jak często w ciągu ostatnich 2 tygodni dokuczały Ci poniższe problemy?</p>
                    <p class="source-cite">Źródło: Kroenke K, et al. (2001). J Gen Intern Med. (Public Domain via Pfizer).</p>
                </div>
                <form id="form-phq9"><div id="phq9-questions"></div></form>

                <div id="phq9-result" class="result-box">
                    <h3>Interpretacja Wyników</h3>
                    <div class="result-row"><span>Suma punktów:</span> <span id="phq9-score"></span></div>
                    <div class="result-row"><span>Poziom depresji:</span> <span id="phq9-interp"></span></div>
                </div>
            </div>
            <div class="btn-action-group">
                <button class="btn btn-calc" onclick="calculatePHQ9()">Oblicz Wynik</button>
                <button class="btn btn-print" onclick="generatePDF('phq9')">Zapisz PDF</button>
            </div>
        </div>

        <div id="gad7" class="test-content">
            <div class="pdf-container">
                <div class="pdf-header">
                    <h2>Wyniki Badania: GAD-7</h2>
                    <p>Pacjent: <span class="p-initials"></span> | Data: <span class="p-date"></span></p>
                </div>
                <div class="test-header">
                    <h2>Skala Lęku Uogólnionego (GAD-7)</h2>
                    <p class="desc">Jak często w ciągu ostatnich 2 tygodni dokuczały Ci poniższe problemy?</p>
                    <p class="source-cite">Źródło: Spitzer RL, et al. (2006). Arch Intern Med.</p>
                </div>
                <form id="form-gad7"><div id="gad7-questions"></div></form>

                <div id="gad7-result" class="result-box">
                    <h3>Interpretacja Wyników</h3>
                    <div class="result-row"><span>Suma punktów:</span> <span id="gad7-score"></span></div>
                    <div class="result-row"><span>Poziom lęku:</span> <span id="gad7-interp"></span></div>
                </div>
            </div>
            <div class="btn-action-group">
                <button class="btn btn-calc" onclick="calculateGAD7()">Oblicz Wynik</button>
                <button class="btn btn-print" onclick="generatePDF('gad7')">Zapisz PDF</button>
            </div>
        </div>

        <div id="bdi" class="test-content">
            <div class="pdf-container">
                <div class="pdf-header">
                    <h2>BDI (Szablon)</h2>
                    <p>Pacjent: <span class="p-initials"></span> | Data: <span class="p-date"></span></p>
                </div>
                <div class="test-header">
                    <h2>Inwentarz Depresji Becka (BDI) - Szablon</h2>
                    <p class="desc" style="color:var(--danger-text)">*Uwaga: Treść chroniona prawem autorskim. Uzupełnij pytania ręcznie.</p>
                </div>
                <form id="form-bdi"><div id="bdi-questions"></div></form>
            </div>
            <div class="btn-action-group">
                <button class="btn btn-print" onclick="generatePDF('bdi')">Zapisz PDF</button>
            </div>
        </div>

        <div id="ybocs" class="test-content">
            <div class="pdf-container">
                <div class="pdf-header">
                    <h2>Y-BOCS (Szablon)</h2>
                    <p>Pacjent: <span class="p-initials"></span> | Data: <span class="p-date"></span></p>
                </div>
                <div class="test-header">
                    <h2>Skala Y-BOCS - Szablon</h2>
                    <p class="desc" style="color:var(--danger-text)">*Uwaga: Treść chroniona prawem autorskim. Uzupełnij pytania ręcznie.</p>
                </div>
                <form id="form-ybocs"><div id="ybocs-questions"></div></form>
            </div>
            <div class="btn-action-group">
                <button class="btn btn-print" onclick="generatePDF('ybocs')">Zapisz PDF</button>
            </div>
        </div>

    </div>

    <script>
        const PASSWORD = "psycholog2026"; 

        // --- Logowanie ---
        function checkPassword() {
            if(document.getElementById('password-input').value === PASSWORD) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('exam-date').valueAsDate = new Date();
                renderAllTests();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }
        document.getElementById('password-input').addEventListener('keypress', (e) => { if(e.key==='Enter') checkPassword(); });

        // --- Nawigacja ---
        function switchTab(id) {
            document.querySelectorAll('.test-content').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.getAttribute('onclick').includes(id)) btn.classList.add('active');
            });
        }

        // --- Generowanie Pytań ---
        function renderAllTests() {
            const dassQ = [
                "Trudno było mi się uspokoić", "Czułem(am) suchość w ustach", "Nie potrafiłem(am) odczuwać żadnych pozytywnych uczuć",
                "Miałem(am) trudności z oddychaniem (np. szybki oddech)", "Trudno było mi nabrać inicjatywy do działania",
                "Miałem(am) tendencję do przesadnego reagowania", "Czułem(am) drżenie (np. rąk)", "Czułem(am), że zużywam dużo nerwowej energii",
                "Martwiłem(am) się sytuacjami, w których mogę wpaść w panikę", "Czułem(am), że nie mam na co czekać w przyszłości",
                "Czułem(am), że staję się poddenerwowany(a)", "Trudno było mi się zrelaksować", "Czułem(am) się przygnębiony(a) i smutny(a)",
                "Nie tolerowałem(am) niczego, co przeszkadzało mi w działaniu", "Czułem(am), że jestem bliski(a) paniki",
                "Nie potrafiłem(am) się niczym entuzjazmować", "Czułem(am), że nie jestem wiele wart(a)", "Czułem(am), że jestem przewrażliwiony(a)",
                "Byłem(am) świadomy(a) rytmu serca bez wysiłku", "Czułem(am) się wystraszony(a) bez powodu", "Czułem(am), że życie nie ma sensu"
            ];
            renderScale('dass-questions', dassQ, [0,1,2,3], "dass_q");

            const phq9Q = [
                "Małe zainteresowanie lub odczuwanie przyjemności z wykonywania czynności", "Uczucie przygnębienia, depresji lub beznadziejności",
                "Kłopoty z zasypianiem/przerywany sen lub zbyt długi sen", "Uczucie zmęczenia lub braku energii",
                "Brak apetytu lub przejadanie się", "Złe samopoczucie na swój temat, uczucie bycia zawiedzionym sobą",
                "Kłopoty z koncentracją (np. czytanie, oglądanie TV)", "Poruszanie się/mówienie tak wolne, że inni zauważają LUB pobudzenie ruchowe",
                "Myśli, że lepiej byłoby nie żyć lub o zrobieniu sobie krzywdy"
            ];
            const phqOpts = ["Wcale (0)", "Kilka dni (1)", "Ponad połowę dni (2)", "Prawie codziennie (3)"];
            renderLabeledScale('phq9-questions', phq9Q, phqOpts, "phq9_q");

            const gad7Q = [
                "Czucie zdenerwowania, lęku lub bycie na krawędzi", "Niezdolność do powstrzymania się od martwienia",
                "Martwienie się zbyt wieloma różnymi rzeczami", "Trudności w zrelaksowaniu się",
                "Bycie tak niespokojnym, że trudno usiedzieć w jednym miejscu", "Łatwe wpadanie w irytację lub rozdrażnienie",
                "Uczucie lęku, jakby miało wydarzyć się coś strasznego"
            ];
            renderLabeledScale('gad7-questions', gad7Q, phqOpts, "gad7_q");

            renderPlaceholder('bdi-questions', 21, 4);
            renderPlaceholder('ybocs-questions', 10, 5);
        }

        function renderScale(containerId, questions, values, namePrefix) {
            const container = document.getElementById(containerId);
            container.innerHTML = questions.map((q, i) => `
                <div class="scale-item">
                    <span class="scale-question">${i+1}. ${q}</span>
                    <div class="options-grid">
                        ${values.map(v => `<label class="radio-label"><input type="radio" name="${namePrefix}${i}" value="${v}"><span>${v}</span></label>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderLabeledScale(containerId, questions, labels, namePrefix) {
            const container = document.getElementById(containerId);
            container.innerHTML = questions.map((q, i) => `
                <div class="scale-item">
                    <span class="scale-question">${i+1}. ${q}</span>
                    <div class="options-grid" style="grid-template-columns: repeat(4, 1fr);">
                        ${labels.map((lbl, idx) => `<label class="radio-label"><input type="radio" name="${namePrefix}${i}" value="${idx}"><span style="font-size:0.75rem">${lbl}</span></label>`).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderPlaceholder(containerId, count, optsCount) {
            const container = document.getElementById(containerId);
            let html = '';
            for(let i=1; i<=count; i++) {
                html += `<div class="scale-item"><span class="scale-question">Pytanie ${i} (Wpisz treść)</span>
                <div class="options-grid">${Array.from({length:optsCount}, (_,j) => `<label class="radio-label"><input type="radio"><span>${j}</span></label>`).join('')}</div></div>`;
            }
            container.innerHTML = html;
        }

        // --- Obliczenia ---
        function calculateDASS() {
            const sDep = [3, 5, 10, 13, 16, 17, 21].map(i => i-1);
            const sAnx = [2, 4, 7, 9, 15, 19, 20].map(i => i-1);
            const sStr = [1, 6, 8, 11, 12, 14, 18].map(i => i-1);
            
            const getSum = (idxArr) => {
                let sum=0, miss=false;
                idxArr.forEach(idx => {
                    const el = document.querySelector(`input[name="dass_q${idx}"]:checked`);
                    if(el) sum += parseInt(el.value); else miss=true;
                });
                return miss ? null : sum * 2;
            };

            const dep=getSum(sDep), anx=getSum(sAnx), str=getSum(sStr);
            if(dep===null || anx===null || str===null) { alert("Wypełnij wszystkie pola."); return; }

            const getInterp = (val, th) => {
                if(val <= th[0]) return `<span class="severity-low">W normie</span>`;
                if(val <= th[1]) return `<span class="severity-med">Łagodny</span>`;
                if(val <= th[2]) return `<span class="severity-med">Umiarkowany</span>`;
                if(val <= th[3]) return `<span class="severity-high">Silny</span>`;
                return `<span class="severity-high">Bardzo silny</span>`;
            };

            document.getElementById('dass-dep-score').innerHTML = `${dep} (${getInterp(dep, [9,13,20,27])})`;
            document.getElementById('dass-anx-score').innerHTML = `${anx} (${getInterp(anx, [7,9,14,19])})`;
            document.getElementById('dass-str-score').innerHTML = `${str} (${getInterp(str, [14,18,25,33])})`;
            document.getElementById('dass-result').style.display = 'block';
        }

        function calculatePHQ9() {
            let sum=0, miss=false;
            for(let i=0; i<9; i++) {
                const el=document.querySelector(`input[name="phq9_q${i}"]:checked`);
                if(el) sum+=parseInt(el.value); else miss=true;
            }
            if(miss){alert("Wypełnij wszystkie pola."); return;}
            
            let txt = sum<=4?"Brak/Minimalna":sum<=9?"Łagodna":sum<=14?"Umiarkowana":sum<=19?"Umiarkowanie ciężka":"Ciężka";
            let cls = sum>9?"severity-high":sum>4?"severity-med":"severity-low";
            
            document.getElementById('phq9-score').innerText = sum;
            document.getElementById('phq9-interp').innerHTML = `<span class="${cls}">${txt}</span>`;
            document.getElementById('phq9-result').style.display = 'block';
        }

        function calculateGAD7() {
            let sum=0, miss=false;
            for(let i=0; i<7; i++) {
                const el=document.querySelector(`input[name="gad7_q${i}"]:checked`);
                if(el) sum+=parseInt(el.value); else miss=true;
            }
            if(miss){alert("Wypełnij wszystkie pola."); return;}
            
            let txt = sum<=4?"Brak/Minimalny":sum<=9?"Łagodny":sum<=14?"Umiarkowany":"Silny";
            let cls = sum>9?"severity-high":sum>4?"severity-med":"severity-low";
            
            document.getElementById('gad7-score').innerText = sum;
            document.getElementById('gad7-interp').innerHTML = `<span class="${cls}">${txt}</span>`;
            document.getElementById('gad7-result').style.display = 'block';
        }

        // --- PDF Generation (FIXED) ---
        function generatePDF(testId) {
            const initials = document.getElementById('patient-initials').value;
            const date = document.getElementById('exam-date').value;

            if(!initials) { alert("Wpisz inicjały pacjenta."); return; }

            const container = document.querySelector(`#${testId} .pdf-container`);

            // 1. Zaktualizuj nagłówki
            container.querySelectorAll('.p-initials').forEach(el => el.innerText = initials);
            container.querySelectorAll('.p-date').forEach(el => el.innerText = date);

            // 2. KLUCZOWA POPRAWKA: Przepisz stan Radio Buttonów do atrybutów HTML
            // Biblioteki html2pdf/html2canvas często ignorują stan "w pamięci", widzą tylko kod.
            // Poniższa pętla wymusza atrybut 'checked' w kodzie.
            const radios = container.querySelectorAll('input[type="radio"]');
            radios.forEach(radio => {
                if (radio.checked) {
                    radio.setAttribute('checked', 'checked');
                } else {
                    radio.removeAttribute('checked');
                }
            });

            // 3. Dodaj klasę, która wymusza widoczność nagłówka i białe tło
            container.classList.add('pdf-mode');

            const opt = {
                margin:       10,
                filename:     `${testId.toUpperCase()}_${initials}_${date}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true, logging: false },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] } // Unikaj cięcia w połowie elementu
            };

            // Generuj
            html2pdf().set(opt).from(container).save().then(() => {
                // Po zakończeniu usuń klasę pomocniczą
                container.classList.remove('pdf-mode');
            });
        }
    </script>
</body>
</html>
